name: Deploy Services

on:
  push:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      first_init:
        description: "Run GCE first-init script (dangerous: edits PG/Redis/firewall)"
        required: false
        default: "false"
        type: boolean
      db_password:
        description: "Optional initial PostgreSQL password for role 'cs'"
        required: false
        default: ""
        type: string

permissions:
  contents: read
  packages: write
  deployments: write

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/cs
  RUN_FIRST_INIT: ${{ vars.GCE_FIRST_INIT || '' }}

jobs:
  build-and-deploy:
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      image_tag: ${{ steps.env.outputs.image_tag }}
      channel_tag: ${{ steps.env.outputs.channel_tag }}
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-services-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify deploy sources exist
        run: |
          set -e
          ls -la scripts/gce
          ls -la infra/gcp/bin

      - name: Determine deployment environment
        id: env
        run: |
          REF="${GITHUB_REF#refs/heads/}"
          if [[ "$REF" == "main" ]]; then
            echo "environment=production" >> "$GITHUB_OUTPUT"
            echo "channel_tag=prod" >> "$GITHUB_OUTPUT"
          elif [[ "$REF" == "staging" ]]; then
            echo "environment=staging" >> "$GITHUB_OUTPUT"
            echo "channel_tag=staging" >> "$GITHUB_OUTPUT"
          else
            echo "Unsupported branch $REF" >&2
            exit 1
          fi
          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-12)
          echo "image_tag=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Build and push Medusa image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/medusa/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-medusa:${{ steps.env.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-medusa:${{ steps.env.outputs.channel_tag }}
          build-args: |
            NODE_ENV=production

      - name: Build and push Strapi image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/strapi/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-strapi:${{ steps.env.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-strapi:${{ steps.env.outputs.channel_tag }}
          build-args: |
            NODE_ENV=production

      - name: Validate deployment secrets
        run: |
          missing=0
          for var in GCE_HOST GCE_USER GCE_SSH_KEY; do
            if [[ -z "${!var:-}" ]]; then
              echo "Missing required secret: $var" >&2
              missing=1
            fi
          done
          if [[ "$missing" -ne 0 ]]; then
            exit 1
          fi
        env:
          GCE_HOST: ${{ secrets.GCE_HOST }}
          GCE_USER: ${{ secrets.GCE_USER }}
          GCE_SSH_KEY: ${{ secrets.GCE_SSH_KEY }}

      - name: Copy deployment tooling to host
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GCE_HOST }}
          username: ${{ secrets.GCE_USER }}
          key: ${{ secrets.GCE_SSH_KEY }}
          # Provide sources as a single comma-separated string (plugin supports comma-separated list)
          # Also switch to explicit relative roots to avoid path resolution quirks
          source: "./scripts/gce/deploy.sh,./scripts/gce/first-init.sh,./infra/gcp/bin/collect-health.sh"
          target: /tmp/cs-deploy
          overwrite: true

      - name: First-time host init (optional)
        if: ${{ (github.event_name == 'workflow_dispatch' && inputs.first_init == true) || env.RUN_FIRST_INIT == 'true' }}
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_PW: ${{ github.event_name == 'workflow_dispatch' && inputs.db_password != '' && inputs.first_init && inputs.db_password || secrets.GCE_DB_PASSWORD || '' }}
        with:
          host: ${{ secrets.GCE_HOST }}
          username: ${{ secrets.GCE_USER }}
          key: ${{ secrets.GCE_SSH_KEY }}
          script: |
            set -euo pipefail
            # Run first-init with optional DB password when provided
            if [ -n "${DB_PW:-}" ]; then
              sudo bash /tmp/cs-deploy/scripts/gce/first-init.sh --db-password "$DB_PW"
            else
              sudo bash /tmp/cs-deploy/scripts/gce/first-init.sh
            fi
            # Keep scripts for later steps
            mkdir -p /srv/cs/bin
            install -m 750 /tmp/cs-deploy/scripts/gce/first-init.sh /srv/cs/bin/first-init.sh

      - name: Deploy services on GCE
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        with:
          host: ${{ secrets.GCE_HOST }}
          username: ${{ secrets.GCE_USER }}
          key: ${{ secrets.GCE_SSH_KEY }}
          script: |
            set -euo pipefail
            mkdir -p /srv/cs/bin
            mkdir -p /srv/cs/logs
            # Copy from the relative paths preserved by scp-action
            install -m 750 /tmp/cs-deploy/scripts/gce/deploy.sh /srv/cs/bin/deploy.sh
            install -m 750 /tmp/cs-deploy/infra/gcp/bin/collect-health.sh /srv/cs/bin/collect-health.sh
            rm -rf /tmp/cs-deploy
            # Authenticate Docker to GHCR on the host for compose pull (PAT preferred, fallback to GITHUB_TOKEN)
            if [ -n "${GHCR_PAT:-}" ]; then
              echo "${GHCR_PAT}" | docker login ghcr.io -u "${GHCR_USERNAME:-${{ github.actor }}}" --password-stdin >/dev/null 2>&1
            else
              echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u '${{ github.actor }}' --password-stdin >/dev/null 2>&1
            fi
            TAG=${{ steps.env.outputs.image_tag }}
            /srv/cs/bin/deploy.sh --tag "$TAG" --cwd /srv/cs
            tail -n 20 /srv/cs/logs/deploy-*.log | sed "s/^/[deploy-log] /"

      - name: Summarize deployment
        run: |
          TAG=${{ steps.env.outputs.image_tag }}
          cat <<SUMMARY >> "$GITHUB_STEP_SUMMARY"
          ## Backend Deployment

          - Environment: **${{ steps.env.outputs.environment }}**
          - Medusa Image: `${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-medusa:${TAG}`
          - Strapi Image: `${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-strapi:${TAG}`
          - GHCR Channel Tag: `${{ steps.env.outputs.channel_tag }}`
          - Health log tail captured in job output (`[deploy-log]` lines)

          Remember to record the run in docs/runbooks/status-log.md with tunnel checks and curl outputs.
          SUMMARY

  smoke-checks:
    name: Post-deploy Smoke Checks
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: needs.build-and-deploy.outputs.environment == 'production'

    steps:
      - name: Curl health endpoints with retries
        shell: bash
        run: |
          set -euo pipefail
          api_url="https://api.aidenlux.com/health"
          cms_url="https://content.aidenlux.com/_health"
          for url in "$api_url" "$cms_url"; do
            echo "Checking $url"
            ok=0
            for i in {1..30}; do
              code=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
              if [ "$url" = "$cms_url" ]; then
                if [ "$code" = "200" ] || [ "$code" = "204" ]; then ok=1; break; fi
              else
                if [ "$code" = "200" ]; then ok=1; break; fi
              fi
              echo "Attempt $i/30: $url -> HTTP $code; retrying in 5s..."
              sleep 5
            done
            if [ $ok -ne 1 ]; then
              echo "❌ Health check failed for $url" >&2
              exit 1
            else
              echo "✅ $url healthy"
            fi
          done

      - name: Add job summary
        run: |
          echo "## Post-deploy Smoke Checks" >> $GITHUB_STEP_SUMMARY
          echo "- Checked https://api.aidenlux.com/health (200 required)" >> $GITHUB_STEP_SUMMARY
          echo "- Checked https://content.aidenlux.com/_health (200/204 accepted)" >> $GITHUB_STEP_SUMMARY
