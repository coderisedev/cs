name: Deploy Web

on:
  push:
    branches: [main, staging]
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main, staging]

permissions:
  contents: read
  deployments: write
  pull-requests: write
  statuses: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}

    outputs:
      environment: ${{ steps.env.outputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
      status: ${{ steps.deploy.outcome }}

    environment:
      name: ${{ steps.env.outputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.2

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Pulumi CLI
        uses: pulumi/setup-pulumi@v3
        with:
          pulumi-version: 3.x

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "branch=main" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "branch=staging" >> $GITHUB_OUTPUT
          else
            echo "Unsupported branch for deployment"
            exit 1
          fi

      - name: Setup Turbo Cache
        uses: actions/cache@v3
        with:
          path: .turbo
          key: turbo-${{ github.job }}-${{ github.ref }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ github.job }}-${{ github.ref }}-
            turbo-${{ github.job }}-

      - name: Deploy to ${{ steps.env.outputs.environment }}
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
          VERCEL_STAGING_PROJECT_ID: ${{ secrets.VERCEL_STAGING_PROJECT_ID }}
          VERCEL_PRODUCTION_PROJECT_ID: ${{ secrets.VERCEL_PRODUCTION_PROJECT_ID }}
          VERCEL_STAGING_URL: ${{ secrets.VERCEL_STAGING_URL }}
          VERCEL_PRODUCTION_URL: ${{ secrets.VERCEL_PRODUCTION_URL }}
          VERCEL_STAGING_DOMAIN_URL: ${{ secrets.VERCEL_STAGING_DOMAIN_URL }}
          VERCEL_PRODUCTION_DOMAIN_URL: ${{ secrets.VERCEL_PRODUCTION_DOMAIN_URL }}
          VERCEL_STAGING_PROJECT_NAME: ${{ secrets.VERCEL_STAGING_PROJECT_NAME }}
          VERCEL_PRODUCTION_PROJECT_NAME: ${{ secrets.VERCEL_PRODUCTION_PROJECT_NAME }}
          PULUMI_STACK_NAME: ${{ steps.env.outputs.environment == 'production' && 'production' || 'staging' }}
        run: |
          echo "ðŸš€ Deploying to ${{ steps.env.outputs.environment }}..."

          # Use the deployment script
          if [[ "${{ steps.env.outputs.environment }}" == "production" ]]; then
            pnpm deploy:production main
          else
            pnpm deploy:staging staging
          fi

      - name: Update commit status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ steps.deploy.outcome }}' === 'success' ? 'success' : 'failure';
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state,
              context: `vercel/${{ steps.env.outputs.environment }}`,
              description: state === 'success' ? 'Deployment succeeded' : 'Deployment failed',
              target_url: '${{ steps.deploy.outputs.url || "" }}'
            });

      - name: Record deployment status
        id: status
        if: always()
        env:
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          DEPLOY_BRANCH: ${{ steps.env.outputs.branch }}
          DEPLOY_URL: ${{ steps.deploy.outputs.url }}
          DEPLOYMENT_ID: ${{ steps.deploy.outputs.deployment_id }}
          GIT_SHA: ${{ github.sha }}
          JOB_STATUS: ${{ job.status }}
        run: |
          STATUS_VALUE=$([[ "$JOB_STATUS" == "success" ]] && echo "success" || echo "failure")
          pnpm deployment-status "$DEPLOY_ENV" "$STATUS_VALUE" "$DEPLOY_URL" "$DEPLOYMENT_ID" "$DEPLOY_BRANCH" "$GIT_SHA"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment to ${{ steps.env.outputs.environment }} failed"
          echo "ðŸ”— Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1

      - name: Comment on PR (if applicable)
        if: always() && github.event_name == 'push' && github.event.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const environment = '${{ steps.env.outputs.environment }}';
            const status = '${{ steps.deploy.outcome }}';
            const deploy_url = '${{ steps.deploy.outputs.url }}';

            const comment_body = `
            ## ðŸš€ Deployment Status

            **Environment**: ${environment}
            **Status**: ${status === 'success' ? 'âœ… Success' : 'âŒ Failed'}
            **URL**: ${deploy_url || 'N/A'}

            ---
            *Deployment triggered by commit: ${context.sha}*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: comment_body
            });

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.deploy.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ needs.deploy.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ needs.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Actions**:" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ needs.deploy.outputs.url }}" ]; then
            echo "- [View Deployment](${{ needs.deploy.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
