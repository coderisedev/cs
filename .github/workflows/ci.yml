name: CI

# Trigger on pull requests to main branch and pushes to main
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  # Trigger preview cleanup on PR close
  pull_request_target:
    types: [closed]
    branches: [main]

# Concurrency control to avoid duplicate runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Environment variables
env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10.18.2"

jobs:
  # Fast gate to block heavy jobs early on PRs
  quick-check:
    name: Quick Check (Changed Packages)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    env:
      TURBO_TELEMETRY_DISABLED: '1'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure origin/main is available
        shell: bash
        run: |
          git fetch --no-tags --prune --depth=1 origin +refs/heads/main:refs/remotes/origin/main
          git rev-parse --abbrev-ref HEAD
          git rev-parse origin/main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/turbo.json') }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint+typecheck only for changed packages
        run: |
          echo "Running quick checks for changed packages vs origin/main"
          npx turbo run lint typecheck --filter=...[origin/main]
  # Lint and typecheck job
  lint:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    needs: [quick-check]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/turbo.json') }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: pnpm lint

      - name: Run type checking
        run: pnpm typecheck

  # Unit tests job
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [quick-check]

    strategy:
      matrix:
        # Test each workspace individually for better error isolation
        workspace: [storefront, medusa, strapi, config]
        include:
          - workspace: storefront
            path: apps/storefront
            test_command: test
          - workspace: medusa
            path: apps/medusa
            test_command: test:unit
          - workspace: strapi
            path: apps/strapi
            test_command: test
          - workspace: config
            path: packages/config
            test_command: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/turbo.json') }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests for ${{ matrix.workspace }}
        run: pnpm --filter ${{ matrix.path }} ${{ matrix.test_command }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.workspace }}
          path: |
            ${{ matrix.path }}/coverage/
            ${{ matrix.path }}/test-results/
          retention-days: 7

  # Build verification job
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [quick-check, lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/turbo.json') }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/storefront/.next/
            apps/medusa/dist/
            apps/strapi/dist/
            packages/*/dist/
          retention-days: 7

  # Preview deployment job (only runs on pull requests)
  preview:
    name: Preview Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [lint, test, build]
    environment:
      name: preview-${{ github.event.number }}
      url: ${{ steps.deploy.outputs.url }}

    outputs:
      url: ${{ steps.deploy.outputs.url }}
      deployment_id: ${{ steps.deploy.outputs.deployment_id }}
      status: ${{ steps.deploy.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/turbo.json') }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./

      - name: Setup preview environment
        run: |
          echo "ðŸ”§ Setting up preview environment..."
          pnpm tsx scripts/bootstrap.ts --env preview
          echo "âœ… Preview environment configured"

      - name: Validate preview configuration
        run: |
          echo "ðŸ” Validating preview environment configuration..."
          pnpm tsx scripts/validate-preview-config.ts
          echo "âœ… Preview configuration validated"

      - name: Deploy to Vercel Preview
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
          VERCEL_STAGING_PROJECT_ID: ${{ secrets.VERCEL_STAGING_PROJECT_ID }}
          VERCEL_STAGING_PROJECT_NAME: ${{ secrets.VERCEL_STAGING_PROJECT_NAME }}
        run: |
          echo "ðŸš€ Deploying preview to Vercel..."

          # Gracefully skip if token is missing
          if [[ -z "${VERCEL_TOKEN:-}" ]]; then
            echo "â„¹ï¸ Skipping Vercel preview: VERCEL_TOKEN not set"
            echo "url=" >> $GITHUB_OUTPUT
            echo "deployment_id=" >> $GITHUB_OUTPUT
            exit 0
          fi

          TEAM_ARG=""
          if [[ -n "${VERCEL_TEAM_ID:-}" ]]; then
            TEAM_ARG="--scope ${VERCEL_TEAM_ID}"
          fi
          PROJ_ARG=""
          if [[ -n "${VERCEL_STAGING_PROJECT_NAME:-}" ]]; then
            PROJ_ARG="--project ${VERCEL_STAGING_PROJECT_NAME}"
          elif [[ -n "${VERCEL_STAGING_PROJECT_ID:-}" ]]; then
            PROJ_ARG="--project ${VERCEL_STAGING_PROJECT_ID}"
          fi

          # Derive scope/project from .vercel file if not set via secrets
          if [[ -z "$TEAM_ARG" || -z "$PROJ_ARG" ]]; then
            if [[ -f apps/storefront/.vercel/project.json ]]; then
              ORG_ID=$(jq -r '.orgId // empty' apps/storefront/.vercel/project.json 2>/dev/null || true)
              PROJ_ID=$(jq -r '.projectId // empty' apps/storefront/.vercel/project.json 2>/dev/null || true)
              if [[ -z "$TEAM_ARG" && -n "$ORG_ID" ]]; then
                echo "âš ï¸  Derived orgId '$ORG_ID' does not include a team slug; skipping --scope auto-fill"
              fi
              if [[ -z "$PROJ_ARG" && -n "$PROJ_ID" ]]; then PROJ_ARG="--project $PROJ_ID"; fi
              echo "Using linkage: TEAM_ARG='$TEAM_ARG' PROJ_ARG='$PROJ_ARG'"
            fi
          fi

          # Build prebuilt output for deterministic preview deploys (produces .vercel/output)
          # If this fails, we will fallback to non-prebuilt deploy below.
          (cd apps/storefront && npx vercel build ${TEAM_ARG} ${PROJ_ARG} --token "${VERCEL_TOKEN}" --yes) || echo "vercel build failed; will try non-prebuilt deploy if needed"

          # Deploy using Vercel CLI with prebuilt artifacts from apps/storefront
          set -o pipefail
          # Try prebuilt deploy first
          vercel_output=$(cd apps/storefront && npx vercel deploy --prebuilt --yes --confirm --json ${TEAM_ARG} ${PROJ_ARG} --token "${VERCEL_TOKEN}" || echo '{}')

          # Parse deployment response
          preview_url=$(echo "$vercel_output" | jq -r '.url // empty')
          deployment_id=$(echo "$vercel_output" | jq -r '.id // empty')

          # Validate deployment succeeded
          if [[ -z "$preview_url" ]]; then
            echo "â„¹ï¸ Prebuilt deploy returned no URL; attempting fallback to non-prebuilt deploy"
            vercel_output=$(cd apps/storefront && npx vercel deploy --yes --confirm --json ${TEAM_ARG} ${PROJ_ARG} --token "${VERCEL_TOKEN}" || echo '{}')
            preview_url=$(echo "$vercel_output" | jq -r '.url // empty')
            deployment_id=$(echo "$vercel_output" | jq -r '.id // empty')
            if [[ -z "$preview_url" ]]; then
              echo "âŒ Preview deployment failed - no URL returned"
              echo "Debug output:"; echo "$vercel_output"
              exit 1
            fi
          fi

          echo "âœ… Preview deployed successfully!"
          echo "ðŸ”— URL: $preview_url"

          # Set outputs for other jobs
          echo "url=$preview_url" >> $GITHUB_OUTPUT
          echo "deployment_id=$deployment_id" >> $GITHUB_OUTPUT

      - name: Wait for deployment to be ready
        run: |
          echo "â³ Waiting for deployment to be ready..."
          max_attempts=30
          attempt=1

          while [[ $attempt -le $max_attempts ]]; do
            status=$(curl -s "https://api.vercel.com/v13/deployments/${{ steps.deploy.outputs.deployment_id }}/ready" \
              -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" | \
              jq -r '.ready // false')

            if [[ "$status" == "true" ]]; then
              echo "âœ… Deployment is ready!"
              break
            fi

            echo "Attempt $attempt/$max_attempts: Deployment not ready yet..."
            sleep 10
            ((attempt++))
          done

          if [[ $attempt -gt $max_attempts ]]; then
            echo "âŒ Deployment failed to become ready within timeout"
            exit 1
          fi

      - name: Post PR comment with preview info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Find existing preview comment
            const existingComment = comments.find(comment =>
              comment.body.includes('ðŸš€ Preview Deployment') &&
              comment.user.type === 'Bot'
            );

            const shortSha = (context.sha || process.env.GITHUB_SHA || '').slice(0, 7);
            const commentBody = `
            ## ðŸš€ Preview Deployment

            **Environment**: Preview
            **Status**: âœ… Deployed Successfully
            **Preview URL**: [${{ steps.deploy.outputs.url }}](${{ steps.deploy.outputs.url }})
            **Branch**: \`${{ github.head_ref }}\`
            **Commit**: \`${shortSha}\`

            ---
            ðŸ¤– *This preview will be automatically cleaned up when the PR is closed*
            `;

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody,
              });
              console.log('Updated existing preview comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
              console.log('Created new preview comment');
            }

  # Playwright smoke tests against preview deployment
  preview-smoke-tests:
    name: Preview Smoke Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && needs.preview.outputs.url != ''
    needs: preview

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright
        run: pnpm exec playwright install --with-deps chromium

      - name: Wait for deployment to be ready
        run: |
          echo "â³ Ensuring preview deployment is ready for testing..."
          max_attempts=60
          attempt=1

          while [[ $attempt -le $max_attempts ]]; do
            http_status=$(curl -s -o /dev/null -w "%{http_code}" "${{ needs.preview.outputs.url }}" || echo "000")

            if [[ "$http_status" == "200" ]]; then
              echo "âœ… Preview deployment is ready for testing!"
              break
            fi

            echo "Attempt $attempt/$max_attempts: HTTP $http_status - waiting..."
            sleep 5
            ((attempt++))
          done

          if [[ $attempt -gt $max_attempts ]]; then
            echo "âŒ Preview deployment failed to become ready within timeout"
            exit 1
          fi

      - name: Run Playwright smoke tests
        id: smoke-tests
        env:
          PREVIEW_URL: ${{ needs.preview.outputs.url }}
        run: |
          echo "ðŸ§ª Running smoke tests against preview: $PREVIEW_URL"

          # Create Playwright config for preview testing
          cat > playwright.config.preview.js << 'EOF'
          import { defineConfig } from '@playwright/test';

          export default defineConfig({
            testDir: './tests/e2e',
            timeout: 30000,
            fullyParallel: true,
            forbidOnly: !!process.env.CI,
            retries: process.env.CI ? 1 : 0,
            workers: process.env.CI ? 1 : 4,
            reporter: 'html',
            use: {
              baseURL: process.env.PREVIEW_URL,
              trace: 'on-first-retry',
              screenshot: 'only-on-failure',
            },
            projects: [
              {
                name: 'chromium',
                use: { ...require('@playwright/test').devices['Desktop Chrome'] },
              },
            ],
            webServer: {
              command: 'echo "Using external preview URL"',
              port: 3000,
              reuseExistingServer: !process.env.CI,
            },
          });
          EOF

          # Run smoke tests
          npx playwright test --config=playwright.config.preview.js --grep="smoke" || {
            echo "âŒ Smoke tests failed against preview deployment"
            exit 1
          }

          echo "âœ… Smoke tests passed!"

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: playwright-report/
          retention-days: 7

      - name: Post test results to PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Find existing preview comment
            const existingComment = comments.find(comment =>
              comment.body.includes('ðŸš€ Preview Deployment') &&
              comment.user.type === 'Bot'
            );

            const testStatus = '${{ steps.smoke-tests.outcome }}' === 'success' ? 'âœ… Passed' : 'âŒ Failed';
            const testResultsUrl = context.payload.repository.html_url + '/actions/runs/' + context.runId;

            const shortSha = (context.sha || process.env.GITHUB_SHA || '').slice(0, 7);
            const updatedCommentBody = `
            ## ðŸš€ Preview Deployment

            **Environment**: Preview
            **Status**: âœ… Deployed Successfully
            **Preview URL**: [${{ needs.preview.outputs.url }}](${{ needs.preview.outputs.url }})
            **Branch**: \`${{ github.head_ref }}\`
            **Commit**: \`${shortSha}\`

            **Smoke Tests**: ${testStatus}
            **Test Results**: [View Details](${testResultsUrl})

            ---
            ðŸ¤– *This preview will be automatically cleaned up when the PR is closed*
            `;

            if (existingComment) {
              // Update existing comment with test results
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: updatedCommentBody,
              });
              console.log('Updated preview comment with test results');
            }

  # Cleanup preview deployments (runs when PR is closed)
  cleanup-preview:
    name: Cleanup Preview Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed'

    steps:
      - name: Cleanup Vercel Preview
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_STAGING_PROJECT_ID }}
        run: |
          echo "ðŸ§¹ Cleaning up preview deployment for PR #${{ github.event.number }}..."

          # Find and remove preview deployment for this branch
          branch_name="${{ github.event.pull_request.head.ref }}"

          # List deployments and find the one for this branch
          deployments=$(npx vercel ls --team ${{ secrets.VERCEL_TEAM_ID }} --scope ${{ secrets.VERCEL_ORG_ID }} --json 2>/dev/null || echo '[]')

          preview_deployment=$(echo "$deployments" | jq -r ".[] | select(.name | contains(\"$branch_name\")) | .url" | head -n 1)

          if [[ -n "$preview_deployment" ]]; then
            echo "Found preview deployment: $preview_deployment"
            npx vercel rm "$preview_deployment" --team ${{ secrets.VERCEL_TEAM_ID }} --scope ${{ secrets.VERCEL_ORG_ID }} --yes
            echo "âœ… Preview deployment removed"
          else
            echo "â„¹ï¸ No preview deployment found for branch: $branch_name"
          fi

  # Workflow summary
  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [lint, test, build, preview, preview-smoke-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate summary
        run: |
          echo "# CI Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Typecheck | ${{ needs.lint.result }} | Code quality checks |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.test.result }} | Test matrix execution |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Verification | ${{ needs.build.result }} | Build validation |" >> $GITHUB_STEP_SUMMARY

          # Add preview deployment info if it ran
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "| Preview Deployment | ${{ needs.preview.result }} | PR preview environment |" >> $GITHUB_STEP_SUMMARY
            echo "| Preview Smoke Tests | ${{ needs.preview-smoke-tests.result }} | E2E validation |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine pipeline status
          pipeline_failed=false
          if [[ "${{ needs.lint.result }}" == "failure" || "${{ needs.test.result }}" == "failure" || "${{ needs.build.result }}" == "failure" ]]; then
            pipeline_failed=true
          fi

          # Include preview jobs in failure check for PRs
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ needs.preview.result }}" == "failure" || "${{ needs.preview-smoke-tests.result }}" == "failure" ]]; then
              pipeline_failed=true
            fi
          fi

          if [[ "$pipeline_failed" == "true" ]]; then
            echo "âŒ **CI Pipeline Failed**" >> $GITHUB_STEP_SUMMARY
            echo "Please check the failed jobs and fix the issues before merging." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **CI Pipeline Passed**" >> $GITHUB_STEP_SUMMARY
            echo "All checks passed. Ready for merge!" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Test results and coverage reports" >> $GITHUB_STEP_SUMMARY
          echo "- Build artifacts (if applicable)" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "- Smoke test results" >> $GITHUB_STEP_SUMMARY
          fi
