# 用费曼学习法彻底搞懂 Medusa.js：以本项目为例

> **费曼技巧核心：**
> 把复杂的软件架构，翻译成现实生活中的场景。
> 如果你能解释清楚“钱怎么算出来的”、“货怎么发出去的”，你就真懂了。

本文将把你正在用的 Medusa 电商引擎，翻译成一个**跨国连锁超市总部**的运作模式。

---

## 第一步：尝试教学——什么是 Medusa？

**想象我们在经营一家叫“Cockpit”的全球连锁超市。**

### 1. Storefront (Next.js) vs Medusa
*   **Storefront 是超市的货架。** 它是给顾客看的。装修得漂不漂亮、灯光亮不亮，这是 Next.js 的事。
*   **Medusa 是超市的“大脑”和“总仓库”。** 它躲在墙后面。它负责：
    *   **记账：** 谁买什么了？
    *   **算钱：** 也就是 Cart 和 Order。
    *   **定规矩：** 美国店卖多少钱？中国店卖多少钱？

**Headless (无头) 是什么意思？**
就是“大脑”和“货架”分开了。
*   今天你想把货架摆在网页上（Web），明天想摆在手机 App 里（Mobile），后天想摆在元宇宙里。
*   **没问题！** 因为大脑（Medusa）不动，你只需要换个装修队（前端）就行。

---

## 第二步：核心概念——三个神奇的机制

Medusa 里面有三个最难懂，但最重要的概念，我们用超市的比喻来拆解。

### 1. Region (区域) = “魔法价签”
你可能会问：*为什么我的商品在美国显示 $100，在中国显示 ¥700？*

*   **Medusa 的逻辑：**
    所有顾客进店前，先发一个**工牌 (Region ID)**。
    *   如果工牌是 `US`，货架上的价签自动变成美元，税率自动变成美国的税率。
    *   如果工牌是 `CN`，价签自动变成人民币。
*   **项目案例：**
    你的 `[countryCode]` 路由，其实就是在发工牌。系统先查 `us` 对应哪个 Region，然后告诉 Medusa：“这个顾客是 `US` 区域的”，Medusa 就吐出美元的价格。

### 2. Dependency Injection (依赖注入) = “魔法工具箱”
你在写代码时经常看到 `req.scope.resolve("productService")`，这是啥？

*   **大白话解释：**
    假如你是修水管的工人（API 接口）。你进客户家不用背着沉重的工具包。
    当你需要扳手时，你只需要喊一声：“给我 **ProductService**！”
    **啪！** 一把扳手（包含所有查商品功能的工具）就凭空出现在你手里。
    你不需要知道扳手是哪家厂造的，只要能用就行。这就是依赖注入——**按需召唤，随叫随到**。

### 3. Subscribers (订阅者) = “对讲机频道”
我们刚才做的“发货自动发邮件”功能，是怎么实现的？

*   **传统做法（耦合）：**
    收银员（Order Service）收完钱，必须亲自跑去邮局寄信，还得跑去仓库喊人发货。累死，而且收银员一旦请假，整个超市瘫痪。
*   **Medusa 做法（解耦）：**
    收银员收完钱，只在对讲机里喊一句：**“频道 `order.placed`，刚才有单子成交了！”**
    *   **仓库管理员**（听到了）：好的，我开始打包。
    *   **邮局专员**（听到了）：好的，我发确认邮件。
    *   **数据分析师**（听到了）：好的，我记在报表上。
    大家各干各的，互不打扰。这就是 **Event-Driven (事件驱动)**。

---

## 第三步：理解原则——为什么有这些规矩？

### 为什么不能直接改数据库？(Service Layer)
*   **原则：不要私自开金库。**
    *   数据库就是金库。如果你在 API 里直接写 SQL 改数据库，就像收银员自己钻进金库拿钱，非常危险。
    *   **Service (服务层)** 就是金库管理员。你想拿钱，必须通过 Service：“我要创建一个订单”。Service 会检查库存够不够、钱对不对，确认无误才帮你改数据库。

### 为什么 Cart (购物车) 那么复杂？
*   **原则：此时此刻的快照。**
    *   你在淘宝买东西，加入购物车时是 100 块。等你结账时，商家涨价到 120 块了。按多少算？
    *   Medusa 的 Cart 极其聪明。它不仅仅是一个商品列表，它是一个**临时的、未完成的订单**。它会实时计算折扣、运费、税费。只有当 Cart 里的所有数字都算平了，它才有资格变成 Order。

---

## 总结：Medusa 的三大铁律

1.  **一切皆 Region：** 不谈区域谈价格都是耍流氓。做任何交易前，先确定 Region。
2.  **通过 Service 办事：** 不要自己动数据库，找对应的 Manager (Service) 帮你办。
3.  **多用对讲机 (Subscribers)：** 想要加新功能（如发积分、发短信），别去改原来的代码，监听一下对讲机频道就行了。

掌握了这三点，你就掌握了 Medusa 的灵魂。
