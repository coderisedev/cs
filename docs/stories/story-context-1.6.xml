<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.6</storyId>
    <title>Provision Railway Services for Medusa &amp; Strapi</title>
    <status>Ready</status>
    <generatedAt>2025-10-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-1.6.md</sourceStoryPath>
  </metadata>

  <story>
    <asA><![CDATA[platform engineer]]></asA>
    <iWant><![CDATA[Medusa and Strapi automatically deployed to Railway across staging and production]]></iWant>
    <soThat><![CDATA[backend services stay in lockstep with storefront releases.]]></soThat>
    <tasks>
      <task id="1" ac="AC1"><![CDATA[Extend Pulumi stacks to provision Medusa, Strapi, Postgres, and Redis services on Railway for staging and production with documented branch mappings.]]></task>
      <task id="1.1" parent="1" ac="AC1"><![CDATA[Create or update `railwayServices` modules in `infra/pulumi` to declare service definitions, database attachments, and environment variables per environment.]]></task>
      <task id="1.2" parent="1" ac="AC1"><![CDATA[Document branch-to-environment deployment mapping (`main` → production, `staging` → staging) inside Pulumi stack config comments and runbooks.]]></task>
      <task id="1.3" parent="1" ac="AC1"><![CDATA[Execute `pulumi preview` followed by approved `pulumi up` for staging and production stacks; capture output artifacts for the status log.]]></task>
      <task id="2" ac="AC2"><![CDATA[Update GitHub Actions `deploy-services.yml` workflow to trigger Railway deploys on branch pushes with surfaced status checks.]]></task>
      <task id="2.1" parent="2" ac="AC2"><![CDATA[Add matrix job steps invoking `railway up` (or Pulumi automation) for Medusa and Strapi, conditioned on `staging` and `main` branch filters.]]></task>
      <task id="2.2" parent="2" ac="AC2"><![CDATA[Publish deployment summaries and log links back to GitHub Checks API so failures block merges.]]></task>
      <task id="2.3" parent="2" ac="AC2"><![CDATA[Implement rollback guard (e.g., `railway rollback`) invoked when deploy step fails after image build/uploads.]]></task>
      <task id="3" ac="AC3"><![CDATA[Mirror environment configuration from Story 1.2 by syncing secrets and connection strings into Railway environments.]]></task>
      <task id="3.1" parent="3" ac="AC3"><![CDATA[Populate Railway variables via Pulumi encrypted config using Story 1.2 `.env.example` templates as authoritative source.]]></task>
      <task id="3.2" parent="3" ac="AC3"><![CDATA[Add validation script to verify required environment variables exist before deployment proceeds.]]></task>
      <task id="3.3" parent="3" ac="AC3"><![CDATA[Run smoke/integration tests against staging endpoints to confirm services boot with synchronized secrets.]]></task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1"><![CDATA[Railway staging and production projects created for Medusa and Strapi with branch-to-environment mappings documented.]]></criterion>
    <criterion id="AC2"><![CDATA[Deployment pipelines trigger on Git pushes (e.g., `staging` → staging, `main` → production) and surface status back to GitHub checks.]]></criterion>
    <criterion id="AC3"><![CDATA[Environment variables, secrets, and database connection strings mirror the configuration strategy from Story 1.2 across all Railway environments.]]></criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics.md" ref="113-124"><![CDATA[Story 1.6 requirements detailing Railway provisioning, deployment automation, and configuration parity expectations.]]></doc>
      <doc path="docs/tech-spec-epic-1.md" ref="20-49"><![CDATA[Epics spec mandates Pulumi-driven Railway provisioning and CI workflows orchestrating service deployments.]]></doc>
      <doc path="docs/tech-spec-epic-1.md" ref="81-159"><![CDATA[Detailed deployment workflows, Pulumi helpers, and IaC acceptance criteria covering environment parity and automated rollbacks.]]></doc>
      <doc path="docs/solution-architecture.md" ref="213-229"><![CDATA[Deployment architecture assigning Medusa/Strapi to Railway with environment isolation via Pulumi-managed secrets.]]></doc>
      <doc path="docs/architecture-decisions.md" ref="53-80"><![CDATA[ADR-002 formalizes Vercel + Railway hosting strategy, motivating current provisioning tasks.]]></doc>
    </docs>
    <code>
      <code path="infra/pulumi"><![CDATA[Pulumi TypeScript project provisioning Railway services, secrets, and database attachments.]]></code>
      <code path=".github/workflows/deploy-services.yml"><![CDATA[GitHub Actions workflow deploying backend services; must be updated with Railway deploy steps and status reporting.]]></code>
      <code path="scripts"><![CDATA[Utility scripts (deployment status, verification) referenced during Railway deploy validation.]]></code>
      <code path="apps/medusa"><![CDATA[Medusa service consuming Railway Postgres/Redis; must reflect synced environment variables.]]></code>
      <code path="apps/strapi"><![CDATA[Strapi CMS configured for Railway hosting; ensure environment variables align with Story 1.2 schema.]]></code>
    </code>
    <dependencies>
      <dependency name="@pulumi/pulumi" version="^3.0.0" source="infra/pulumi/package.json:dependencies" />
      <dependency name="@pulumi/railway" version="latest" source="infra/pulumi/package.json:dependencies" />
      <dependency name="railway" version="latest" source="package.json:devDependencies" />
      <dependency name="typescript" version="^5.0.0" source="infra/pulumi/package.json:devDependencies" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="docs/tech-spec-epic-1.md:20-49"><![CDATA[Infrastructure provisioning must run through Pulumi with GitHub OIDC authentication; manual dashboard edits are prohibited.]]></constraint>
    <constraint source="docs/tech-spec-epic-1.md:81-110"><![CDATA[`deploy-services.yml` is the canonical automation surface; deployments must report via GitHub Checks and support manual approvals.]]></constraint>
    <constraint source="docs/tech-spec-epic-1.md:126-135"><![CDATA[Secrets are stored in Pulumi encrypted config and synchronized to Railway; production credentials may not traverse CI logs.]]></constraint>
    <constraint source="docs/solution-architecture.md:217-229"><![CDATA[Staging, preview, and production environments remain isolated with distinct Railway services and Pulumi-managed variables.]]></constraint>
    <constraint source="docs/architecture-decisions.md:53-80"><![CDATA[Hosting must remain on Vercel + Railway, so solutions cannot introduce alternative providers without new ADRs.]]></constraint>
  </constraints>

  <interfaces>
    <interface type="pulumi" name="RailwayStackConfig"><![CDATA[Defines service IDs, database attachments, and environment selection (`staging`, `production`) for Railway provisioning.]]></interface>
    <interface type="github-actions" name="deploy-services.yml::railway-deploy"><![CDATA[Workflow job executing Pulumi/railway CLI to build images, push to Railway, and annotate status checks.]]></interface>
    <interface type="cli" name="railway up"><![CDATA[CLI command used inside CI or locally to deploy services; must authenticate via API token or CLI context stored in secrets.]]></interface>
    <interface type="script" name="scripts/deployment-status.ts"><![CDATA[Utility to poll Railway deployment status and emit logs/metrics for dashboards and GitHub summary.]]></interface>
  </interfaces>

  <tests>
    <standards><![CDATA[Follow Story 1.2 configuration validation, run Pulumi previews before applies, and execute integration smoke tests after each deployment.]]></standards>
    <locations><![CDATA[infra/pulumi/**/*.test.ts; scripts/**/*.spec.ts; tests/integration/**/*.spec.ts]]></locations>
    <ideas>
      <idea ac="AC1"><![CDATA[Run Pulumi preview verifying new Railway resources without drift; ensure diff shows expected service/database additions.]]></idea>
      <idea ac="AC2"><![CDATA[Trigger staged branch push and confirm GitHub status checks report Railway deploy success/failure with logs.]]></idea>
      <idea ac="AC3"><![CDATA[Execute staging smoke test hitting Medusa and Strapi endpoints with new environment variables to confirm configuration parity.]]></idea>
    </ideas>
  </tests>
</story-context>
