# Medusa 2.x æ·±åº¦æ•™ç¨‹ï¼šä»ç¬¬ä¸€æ€§åŸç†åˆ°ç”Ÿäº§å®æˆ˜

> é‡‡ç”¨é©¬æ–¯å…‹ç¬¬ä¸€æ€§åŸç† + è´¹æ›¼å­¦ä¹ æ³•ï¼Œä»¥ Cockpit Simulator çœŸå®é¡¹ç›®ä¸ºæ¡ˆä¾‹

---

## ç›®å½•

- [å‰è¨€ï¼šå­¦ä¹ æ–¹æ³•è®º](#å‰è¨€å­¦ä¹ æ–¹æ³•è®º)
- [ç¬¬ä¸€ç« ï¼šç”µå•†åç«¯çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ](#ç¬¬ä¸€ç« ç”µå•†åç«¯çš„æœ¬è´¨æ˜¯ä»€ä¹ˆ)
- [ç¬¬äºŒç« ï¼šMedusa çš„æ¶æ„å“²å­¦â€”â€”ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·ï¼Ÿ](#ç¬¬äºŒç« medusa-çš„æ¶æ„å“²å­¦ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·)
- [ç¬¬ä¸‰ç« ï¼šæ¨¡å—ç³»ç»Ÿâ€”â€”ä¹é«˜ç§¯æœ¨å¼çš„å•†ä¸šé€»è¾‘](#ç¬¬ä¸‰ç« æ¨¡å—ç³»ç»Ÿä¹é«˜ç§¯æœ¨å¼çš„å•†ä¸šé€»è¾‘)
- [ç¬¬å››ç« ï¼šæ•°æ®æµå…¨æ™¯â€”â€”ä¸€ä¸ªè®¢å•çš„ä¸€ç”Ÿ](#ç¬¬å››ç« æ•°æ®æµå…¨æ™¯ä¸€ä¸ªè®¢å•çš„ä¸€ç”Ÿ)
- [ç¬¬äº”ç« ï¼šå››å¤§æ‰©å±•æœºåˆ¶â€”â€”å¦‚ä½•è®© Medusa åšä½ æƒ³åšçš„äº‹](#ç¬¬äº”ç« å››å¤§æ‰©å±•æœºåˆ¶å¦‚ä½•è®©-medusa-åšä½ æƒ³åšçš„äº‹)
- [ç¬¬å…­ç« ï¼šå‰åç«¯é›†æˆâ€”â€”Next.js å¦‚ä½•ä¸ Medusa å¯¹è¯](#ç¬¬å…­ç« å‰åç«¯é›†æˆnextjs-å¦‚ä½•ä¸-medusa-å¯¹è¯)
- [ç¬¬ä¸ƒç« ï¼šè®¤è¯ä½“ç³»â€”â€”ä» OTP åˆ° OAuth çš„å…¨é“¾è·¯](#ç¬¬ä¸ƒç« è®¤è¯ä½“ç³»ä»-otp-åˆ°-oauth-çš„å…¨é“¾è·¯)
- [ç¬¬å…«ç« ï¼šä»æœ¬åœ°åˆ°ç”Ÿäº§â€”â€”éƒ¨ç½²çš„å®Œæ•´é“¾è·¯](#ç¬¬å…«ç« ä»æœ¬åœ°åˆ°ç”Ÿäº§éƒ¨ç½²çš„å®Œæ•´é“¾è·¯)
- [ç¬¬ä¹ç« ï¼šæ¦‚å¿µé€ŸæŸ¥è¡¨](#ç¬¬ä¹ç« æ¦‚å¿µé€ŸæŸ¥è¡¨)

---

## å‰è¨€ï¼šå­¦ä¹ æ–¹æ³•è®º

### é©¬æ–¯å…‹ç¬¬ä¸€æ€§åŸç†

> "æŠŠçŸ¥è¯†çœ‹ä½œä¸€æ£µè¯­ä¹‰æ ‘â€”â€”å…ˆç¡®ä¿ä½ ç†è§£äº†åŸºæœ¬åŸç†ï¼ˆæ ‘å¹²å’Œå¤§æï¼‰ï¼Œå†å»äº†è§£ç»†èŠ‚ï¼ˆæ ‘å¶ï¼‰ï¼Œå¦åˆ™æ ‘å¶å°±æ²¡æœ‰ä¸œè¥¿å¯ä»¥æŒ‚é ã€‚" â€”â€” Elon Musk

æœ¬æ•™ç¨‹ä¸ä¼šä¸€ä¸Šæ¥å°±æ•™ä½  `pnpm dev`ã€‚æˆ‘ä»¬å…ˆå›ç­”ï¼š

1. **ç”µå•†åç«¯åˆ°åº•åœ¨è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ** ï¼ˆæ ¹æœ¬é—®é¢˜ï¼‰
2. **ä¸ºä»€ä¹ˆä¼ ç»Ÿæ–¹æ¡ˆä¸å¤Ÿå¥½ï¼Ÿ** ï¼ˆæ‰“ç ´ç±»æ¯”æ¨ç†ï¼‰
3. **ä»ç‰©ç†å®šå¾‹çº§åˆ«é‡æ–°æ¨å¯¼ï¼ŒMedusa çš„è®¾è®¡å¿…ç„¶æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ** ï¼ˆç¬¬ä¸€æ€§åŸç†é‡å»ºï¼‰

### è´¹æ›¼å­¦ä¹ æ³•

> "å¦‚æœä½ ä¸èƒ½ç”¨ç®€å•çš„è¯å‘ä¸€ä¸ªå…­å¹´çº§å­¦ç”Ÿè§£é‡Šæ¸…æ¥šï¼Œè¯´æ˜ä½ è‡ªå·±ä¹Ÿæ²¡çœŸæ­£ç†è§£ã€‚"

æ¯ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œæˆ‘ä»¬éƒ½ä¼šï¼š

1. **ç”¨ä¸€å¥å¤§ç™½è¯è¯´æ¸…æ¥šå®ƒæ˜¯ä»€ä¹ˆ**
2. **ç”¨ä¸€ä¸ªç”Ÿæ´»ç±»æ¯”è®©ä½ "å•Šå“ˆ"ä¸€ä¸‹**
3. **çœ‹çœŸå®ä»£ç éªŒè¯ç†è§£**
4. **æ‰¾å‡ºè‡ªå·±è¿˜ä¸æ‡‚çš„åœ°æ–¹ï¼Œå›åˆ°ç¬¬1æ­¥**

---

## ç¬¬ä¸€ç« ï¼šç”µå•†åç«¯çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

### ä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘

å¿˜æ‰ Shopifyã€WooCommerceã€Medusa è¿™äº›åå­—ã€‚å›åˆ°æœ€åŸºæœ¬çš„é—®é¢˜ï¼š

**ä¸€ä¸ªäººæƒ³åœ¨ç½‘ä¸Šå–ä¸œè¥¿ç»™å¦ä¸€ä¸ªäººï¼Œä¸­é—´éœ€è¦ä»€ä¹ˆï¼Ÿ**

åˆ†è§£æˆä¸å¯å†ç®€åŒ–çš„åŸºæœ¬è¦ç´ ï¼š

```
1. å•†å“ç›®å½•  â€”â€” å–ä»€ä¹ˆï¼Ÿä»€ä¹ˆä»·æ ¼ï¼Ÿè¿˜æœ‰åº“å­˜å—ï¼Ÿ
2. é¡¾å®¢èº«ä»½  â€”â€” è°åœ¨ä¹°ï¼Ÿæ€ä¹ˆè¯æ˜æ˜¯ä»–ï¼Ÿ
3. è´­ç‰©è½¦    â€”â€” ä»–æƒ³ä¹°å“ªäº›ï¼Ÿæ•°é‡ï¼Ÿ
4. åœ°å€ä¸ç‰©æµ â€”â€” å¯„åˆ°å“ªï¼Ÿæ€ä¹ˆå¯„ï¼Ÿè¿è´¹å¤šå°‘ï¼Ÿ
5. æ”¯ä»˜      â€”â€” æ€ä¹ˆæ”¶é’±ï¼Ÿ
6. è®¢å•      â€”â€” ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯çš„ä¸€ä»½"åˆåŒ"
7. é€šçŸ¥      â€”â€” ä¸‹å•äº†ã€å‘è´§äº†ã€åˆ°äº†ï¼Œå‘Šè¯‰ä¹°å®¶
```

**è¿™å°±æ˜¯ç”µå•†çš„"ç‰©ç†å®šå¾‹"ã€‚æ— è®ºä½ ç”¨ä»€ä¹ˆæŠ€æœ¯ï¼Œè¿™7ä¸ªè¦ç´ ä¸€ä¸ªéƒ½å°‘ä¸äº†ã€‚**

### ç”¨è´¹æ›¼çš„æ–¹å¼ç†è§£

æƒ³è±¡ä½ å¼€äº†ä¸€å®¶å®ä½“åº—ï¼š

| å®ä½“åº— | ç”µå•†åç«¯ |
|--------|----------|
| è´§æ¶ä¸Šçš„å•†å“å’Œä»·ç­¾ | Product + Price æ¨¡å— |
| ä¼šå‘˜å¡ | Customer + Auth æ¨¡å— |
| è´­ç‰©ç¯® | Cart æ¨¡å— |
| æ”¶é“¶å° | Payment æ¨¡å— |
| å¿«é€’å• | Fulfillment æ¨¡å— |
| å‘ç¥¨/æ”¶æ® | Order æ¨¡å— |
| çŸ­ä¿¡é€šçŸ¥ | Notification æ¨¡å— |

Medusa åšçš„äº‹æƒ…ï¼Œå°±æ˜¯**æŠŠè¿™å®¶å®ä½“åº—æ•°å­—åŒ–**ï¼Œæ¯ä¸ªæŸœå°å˜æˆä¸€ä¸ªç‹¬ç«‹çš„"æ¨¡å—"ã€‚

### ä¸ºä»€ä¹ˆä¸ç”¨ Shopifyï¼Ÿ

ç”¨ç¬¬ä¸€æ€§åŸç†åˆ†æï¼š

| éœ€æ±‚ | Shopify | Medusa |
|------|---------|--------|
| å¿«é€Ÿä¸Šçº¿ | æå¥½ï¼ˆå¼€ç®±å³ç”¨ï¼‰ | éœ€è¦å¼€å‘ |
| è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ | å—é™ï¼ˆåªèƒ½ç”¨ Liquid æ¨¡æ¿å’Œ Appï¼‰ | å®Œå…¨è‡ªç”±ï¼ˆä»£ç çº§æ§åˆ¶ï¼‰ |
| æ•°æ®æ‰€æœ‰æƒ | æ•°æ®åœ¨ Shopify æœåŠ¡å™¨ | æ•°æ®åœ¨ä½ çš„æ•°æ®åº“ |
| å‰ç«¯è‡ªç”±åº¦ | å—é™äº Shopify ä¸»é¢˜ | ä»»æ„å‰ç«¯æ¡†æ¶ |
| æˆæœ¬ç»“æ„ | æœˆè´¹ + äº¤æ˜“æŠ½æˆ | å¼€æºå…è´¹ï¼ˆåªä»˜æœåŠ¡å™¨ï¼‰ |

**ç»“è®ºï¼šå¦‚æœä½ çš„ä¸šåŠ¡æœ‰ä»»ä½•"ä¸æ ‡å‡†"çš„åœ°æ–¹ï¼ˆè‡ªå®šä¹‰è®¤è¯ã€ç‰¹æ®Šè¿è´¹è®¡ç®—ã€å¤šå‰ç«¯ã€ç§æœ‰éƒ¨ç½²ï¼‰ï¼ŒMedusa å°±æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚**

æœ¬é¡¹ç›® Cockpit Simulator æ­£æ˜¯è¿™æ ·â€”â€”éœ€è¦ OTP ç™»å½•ã€Discord/Google/Facebook OAuthã€åŠ¨æ€è¿è´¹è®¡ç®—ã€Discourse è®ºå› SSO é›†æˆã€‚è¿™äº›åœ¨ Shopify ä¸Šè¦ä¹ˆåšä¸åˆ°ï¼Œè¦ä¹ˆæˆæœ¬æé«˜ã€‚

---

## ç¬¬äºŒç« ï¼šMedusa çš„æ¶æ„å“²å­¦â€”â€”ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·ï¼Ÿ

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

ç”¨ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ Medusa çš„æ¶æ„ï¼š

**é—®é¢˜**ï¼šç”µå•†ç³»ç»Ÿéœ€è¦çµæ´»ã€å¯æ‰©å±•ã€å¯æ›¿æ¢éƒ¨ä»¶ã€‚

**æ¨å¯¼**ï¼š
1. ä¸šåŠ¡é€»è¾‘åº”è¯¥è¢«**æ¨¡å—åŒ–**ï¼ˆæ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ï¼‰
2. æ¨¡å—ä¹‹é—´åº”è¯¥é€šè¿‡**äº‹ä»¶**é€šä¿¡ï¼ˆè§£è€¦ï¼‰
3. å¤æ‚æ“ä½œåº”è¯¥æœ‰**äº‹åŠ¡æ€§ä¿è¯**ï¼ˆè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å›æ»šï¼‰
4. å¤–éƒ¨ç³»ç»Ÿï¼ˆæ”¯ä»˜ã€é‚®ä»¶ï¼‰åº”è¯¥é€šè¿‡**Provider æ¨¡å¼**æŠ½è±¡

Medusa 2.x çš„æ¶æ„æ­£æ˜¯è¿™å››æ¡æ¨å¯¼çš„äº§ç‰©ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    medusa-config.ts                       â”‚
â”‚            ï¼ˆé…ç½®ä¸­å¿ƒï¼šæ³¨å†Œæ‰€æœ‰æ¨¡å—å’ŒProviderï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Product  â”‚ â”‚Customer â”‚ â”‚  Cart    â”‚ â”‚   Order     â”‚  â”‚
â”‚  â”‚ Module   â”‚ â”‚ Module  â”‚ â”‚ Module   â”‚ â”‚   Module    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚            â”‚            â”‚              â”‚          â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                         â”‚                                 â”‚
â”‚                    Event Bus                              â”‚
â”‚                         â”‚                                 â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚       â”‚                 â”‚                 â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚Subscriberâ”‚  â”‚  Subscriber   â”‚  â”‚ Subscriber  â”‚       â”‚
â”‚  â”‚(å‘é‚®ä»¶)  â”‚  â”‚(åŒæ­¥Discourse)â”‚  â”‚ (è®°æ—¥å¿—)    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Providers:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Auth   â”‚ â”‚Payment â”‚ â”‚ File   â”‚ â”‚  Fulfillment    â”‚  â”‚
â”‚  â”‚Providerâ”‚ â”‚Providerâ”‚ â”‚Providerâ”‚ â”‚    Provider      â”‚  â”‚
â”‚  â”‚Google  â”‚ â”‚PayPal  â”‚ â”‚  R2    â”‚ â”‚ Dynamic Shippingâ”‚  â”‚
â”‚  â”‚Discord â”‚ â”‚Stripe  â”‚ â”‚  S3    â”‚ â”‚    Manual        â”‚  â”‚
â”‚  â”‚Facebookâ”‚ â”‚        â”‚ â”‚        â”‚ â”‚                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç”¨è´¹æ›¼ç±»æ¯”ç†è§£æ¶æ„

**Medusa å°±åƒä¸€ä¸ªä¹é«˜åŸå ¡ï¼š**

- **æ¨¡å—ï¼ˆModuleï¼‰** = ä¹é«˜ç§¯æœ¨å—ã€‚æ¯ä¸€å—è´Ÿè´£ä¸€ä¸ªåŠŸèƒ½ï¼ˆäº§å“ã€è´­ç‰©è½¦ã€è®¢å•...ï¼‰ï¼Œå¯ä»¥ç‹¬ç«‹æ›¿æ¢ã€‚
- **Provider** = ç§¯æœ¨å—çš„"çš®è‚¤"ã€‚åŒä¸€ä¸ªæ”¯ä»˜æ¨¡å—ï¼Œå¯ä»¥è´´ PayPal çš„çš®è‚¤ï¼Œä¹Ÿå¯ä»¥è´´ Stripe çš„çš®è‚¤ã€‚
- **äº‹ä»¶æ€»çº¿ï¼ˆEvent Busï¼‰** = åŸå ¡é‡Œçš„å¹¿æ’­ç³»ç»Ÿã€‚"æœ‰äººä¸‹å•äº†ï¼"â€”â€”æ‰€æœ‰å…³å¿ƒè¿™ä¸ªæ¶ˆæ¯çš„äººï¼ˆSubscriberï¼‰éƒ½èƒ½å¬åˆ°ã€‚
- **Workflow** = ä¸€å¥—æ–½å·¥æµç¨‹å›¾ã€‚"å…ˆæ£€æŸ¥åº“å­˜ â†’ å†æ‰£æ¬¾ â†’ å†ç”Ÿæˆè®¢å•"ï¼Œä¸­é—´ä»»ä½•ä¸€æ­¥å¤±è´¥éƒ½å¯ä»¥å›æ»šã€‚
- **medusa-config.ts** = åŸå ¡çš„è“å›¾ã€‚å‘Šè¯‰ç³»ç»Ÿ"ç”¨å“ªäº›ç§¯æœ¨ã€è´´å“ªäº›çš®è‚¤"ã€‚

### medusa-config.tsâ€”â€”ä¸€åˆ‡çš„èµ·ç‚¹

è¿™æ˜¯æœ¬é¡¹ç›®çš„é…ç½®æ–‡ä»¶æ ¸å¿ƒç»“æ„ï¼ˆåˆ å»äº†å˜é‡å£°æ˜ï¼Œåªçœ‹éª¨æ¶ï¼‰ï¼š

```typescript
// apps/medusa/medusa-config.ts

export default defineConfig({
  // ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®åŸºç¡€è®¾æ–½
  projectConfig: {
    databaseUrl: DATABASE_URL,        // PostgreSQL æ•°æ®åº“
    redisUrl: REDIS_URL,              // Redis ç¼“å­˜ & äº‹ä»¶é˜Ÿåˆ—
    http: {
      storeCors: STORE_CORS,          // å‰ç«¯å…è®¸çš„åŸŸå
      adminCors: ADMIN_CORS,          // ç®¡ç†åå°å…è®¸çš„åŸŸå
      authCors: AUTH_CORS,            // è®¤è¯ç›¸å…³å…è®¸çš„åŸŸå
      jwtSecret: JWT_SECRET,          // JWT ç­¾åå¯†é’¥
      cookieSecret: COOKIE_SECRET,    // Cookie åŠ å¯†å¯†é’¥
    },
  },

  // ç¬¬äºŒéƒ¨åˆ†ï¼šç®¡ç†åå° UI é…ç½®
  admin: {
    vite: () => ({
      base: "/app/",                  // ç®¡ç†åå° URL å‰ç¼€
    }),
  },

  // ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¨¡å—æ³¨å†Œï¼ˆæ ¸å¿ƒï¼ï¼‰
  modules: {
    [Modules.AUTH]: { ... },          // è®¤è¯æ¨¡å—
    [Modules.FILE]: { ... },          // æ–‡ä»¶å­˜å‚¨æ¨¡å—
    [Modules.PAYMENT]: { ... },       // æ”¯ä»˜æ¨¡å—
    [Modules.NOTIFICATION]: { ... },  // é€šçŸ¥æ¨¡å—
    [Modules.FULFILLMENT]: { ... },   // ç‰©æµæ¨¡å—
  },
})
```

**å…³é”®æ´å¯Ÿ**ï¼š`modules` å°±æ˜¯ä½ çš„"ç§¯æœ¨æ¸…å•"ã€‚ä½ åœ¨è¿™é‡Œå£°æ˜ç”¨ä»€ä¹ˆæ¨¡å—ã€ä»€ä¹ˆ Providerã€‚Medusa å¯åŠ¨æ—¶è¯»å–è¿™ä¸ªé…ç½®ï¼ŒæŠŠä¸€åˆ‡ç»„è£…èµ·æ¥ã€‚

---

## ç¬¬ä¸‰ç« ï¼šæ¨¡å—ç³»ç»Ÿâ€”â€”ä¹é«˜ç§¯æœ¨å¼çš„å•†ä¸šé€»è¾‘

### ä»€ä¹ˆæ˜¯æ¨¡å—ï¼Ÿ

**ä¸€å¥è¯**ï¼šæ¨¡å— = ä¸€ç»„ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ + æ•°æ®æ¨¡å‹ + APIï¼Œæ‰“åŒ…æˆä¸€ä¸ªç‹¬ç«‹å•å…ƒã€‚

**è´¹æ›¼ç±»æ¯”**ï¼šæ¨¡å—å°±åƒæ‰‹æœºé‡Œçš„ Appã€‚ç›¸æœº App ç®¡æ‹ç…§ã€é’±åŒ… App ç®¡æ”¯ä»˜ï¼Œå®ƒä»¬å„å¹²å„çš„ï¼Œä½†å¯ä»¥äº’ç›¸è°ƒç”¨ã€‚

### Medusa çš„å†…ç½®æ¨¡å—

```
æ ¸å¿ƒå•†åŠ¡æ¨¡å—ï¼ˆMedusa è‡ªå¸¦ï¼‰ï¼š
â”œâ”€â”€ Product     â€”â€” å•†å“ã€å˜ä½“ã€ä»·æ ¼ã€åˆ†ç±»ã€å›¾ç‰‡
â”œâ”€â”€ Customer    â€”â€” é¡¾å®¢ä¿¡æ¯ã€åœ°å€ç°¿
â”œâ”€â”€ Cart        â€”â€” è´­ç‰©è½¦ã€è¡Œé¡¹ç›®
â”œâ”€â”€ Order       â€”â€” è®¢å•ç®¡ç†
â”œâ”€â”€ Payment     â€”â€” æ”¯ä»˜å¤„ç†
â”œâ”€â”€ Fulfillment â€”â€” ç‰©æµå’Œå‘è´§
â”œâ”€â”€ Inventory   â€”â€” åº“å­˜ç®¡ç†
â”œâ”€â”€ Pricing     â€”â€” ä»·æ ¼è®¡ç®—ã€ä¿ƒé”€
â”œâ”€â”€ Tax         â€”â€” ç¨è´¹è®¡ç®—
â”œâ”€â”€ Auth        â€”â€” èº«ä»½è®¤è¯
â”œâ”€â”€ File        â€”â€” æ–‡ä»¶ä¸Šä¼ /å­˜å‚¨
â”œâ”€â”€ Notificationâ€”â€” æ¶ˆæ¯é€šçŸ¥
â”œâ”€â”€ Sales Channel â€”â€” å¤šæ¸ é“é”€å”®ï¼ˆWebã€Appã€B2B...ï¼‰
â””â”€â”€ Region      â€”â€” åœ°åŒº/è´§å¸ç®¡ç†
```

### æ¨¡å— vs Providerâ€”â€”ä¸€ä¸ªå…³é”®åŒºåˆ†

å¾ˆå¤šåˆå­¦è€…åˆ†ä¸æ¸…æ¨¡å—å’Œ Providerã€‚ç”¨è´¹æ›¼çš„è¯è¯´ï¼š

> **æ¨¡å—æ˜¯"åšä»€ä¹ˆ"ï¼ŒProvider æ˜¯"æ€ä¹ˆåš"ã€‚**

| | æ¨¡å—ï¼ˆModuleï¼‰ | Provider |
|---|---|---|
| **æ˜¯ä»€ä¹ˆ** | å®šä¹‰ä¸šåŠ¡èƒ½åŠ›ï¼ˆ"æˆ‘éœ€è¦å‘é€é€šçŸ¥"ï¼‰ | å…·ä½“å®ç°ï¼ˆ"é€šè¿‡ Resend å‘é‚®ä»¶"ï¼‰ |
| **æ•°é‡** | æ¯ç§èƒ½åŠ›ä¸€ä¸ªï¼ˆä¸€ä¸ª Notification æ¨¡å—ï¼‰ | å¯ä»¥æœ‰å¤šä¸ªï¼ˆResendã€SendGridã€Twilio...ï¼‰ |
| **å…³ç³»** | æ¨¡å—åŒ…å« Provider | Provider å±äºæ¨¡å— |
| **æ›¿æ¢** | é€šå¸¸ä¸æ›¿æ¢ | ç»å¸¸æ›¿æ¢ï¼ˆæ¢æ”¯ä»˜æ–¹å¼ã€æ¢é‚®ä»¶æœåŠ¡ï¼‰ |

çœ‹å®é™…é…ç½®ç†è§£è¿™ä¸ªå…³ç³»ï¼š

```typescript
// apps/medusa/medusa-config.ts

// Notification æ˜¯æ¨¡å—ï¼ŒResend æ˜¯ Provider
[Modules.NOTIFICATION]: {
  resolve: "@medusajs/medusa/notification",  // æ¨¡å—ï¼ˆåšä»€ä¹ˆï¼šå‘é€šçŸ¥ï¼‰
  options: {
    providers: [
      {
        resolve: "./src/modules/resend-notification",  // Providerï¼ˆæ€ä¹ˆåšï¼šç”¨ Resendï¼‰
        id: "resend",
        options: {
          channels: ["email"],
          apiKey: RESEND_API_KEY,
          fromEmail: RESEND_FROM_EMAIL,
        },
      },
    ],
  },
},

// Fulfillment æ˜¯æ¨¡å—ï¼Œmanual å’Œ dynamic-shipping æ˜¯ä¸¤ä¸ª Provider
[Modules.FULFILLMENT]: {
  resolve: "@medusajs/medusa/fulfillment",   // æ¨¡å—ï¼ˆåšä»€ä¹ˆï¼šå¤„ç†ç‰©æµï¼‰
  options: {
    providers: [
      {
        resolve: "@medusajs/medusa/fulfillment-manual",  // Provider 1ï¼šæ‰‹åŠ¨å‘è´§
        id: "manual",
      },
      {
        resolve: "./src/modules/dynamic-shipping",        // Provider 2ï¼šåŠ¨æ€è¿è´¹
        id: "dynamic-shipping",
        options: { base_price: 1000 },
      },
    ],
  },
},
```

### è‡ªå®šä¹‰ Provider çš„è§£å‰–

ä»¥æœ¬é¡¹ç›®çš„ **Dynamic Shipping Provider** ä¸ºä¾‹ï¼Œæ‹†è§£ä¸€ä¸ª Provider çš„å®Œæ•´ç»“æ„ï¼š

```typescript
// apps/medusa/src/modules/dynamic-shipping/service.ts

// ç¬¬ 1 æ­¥ï¼šç»§æ‰¿æŠ½è±¡åŸºç±»
class DynamicShippingProviderService extends AbstractFulfillmentProviderService {
  static identifier = "dynamic-shipping"   // å”¯ä¸€æ ‡è¯†ç¬¦

  // ç¬¬ 2 æ­¥ï¼šæ¥æ”¶ä¾èµ–æ³¨å…¥ï¼ˆMedusa è‡ªåŠ¨æ³¨å…¥ logger ç­‰ï¼‰
  constructor({ logger }, options) {
    super()
    this.logger = logger
    this.options = options    // æ¥è‡ª medusa-config.ts çš„é…ç½®
  }

  // ç¬¬ 3 æ­¥ï¼šå®ç°å¿…è¦çš„æ¥å£æ–¹æ³•

  // "ä½ èƒ½æä¾›å“ªäº›è¿è¾“é€‰é¡¹ï¼Ÿ"
  async getFulfillmentOptions() {
    return [
      { id: "dynamic-standard", name: "Standard Shipping (Calculated)" },
      { id: "dynamic-express", name: "Express Shipping (Calculated)" },
    ]
  }

  // "è¿™ä¸ªè¿è´¹æ˜¯å¤šå°‘ï¼Ÿ"ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
  async calculatePrice(optionData, data, context) {
    const items = context?.items || []
    const countryCode = context.shipping_address?.country_code

    // æ ¹æ®å•†å“å’Œç›®çš„åœ°å›½å®¶è®¡ç®—è¿è´¹
    let totalShipping = 0
    for (const item of items) {
      const handle = item.variant?.product?.handle
      const rates = PRODUCT_SHIPPING_RATES[handle]
      if (rates) {
        const regionKey = COUNTRY_TO_REGION[countryCode] || "default"
        totalShipping += (rates[regionKey] ?? rates.default) * item.quantity
      }
    }

    return {
      calculated_amount: totalShipping,        // å•ä½ï¼šåˆ†ï¼ˆcentsï¼‰
      is_calculated_price_tax_inclusive: false,
    }
  }

  // "åˆ›å»ºä¸€ä¸ªå‘è´§è®°å½•"
  async createFulfillment(data, items, order, fulfillment) {
    return {
      data: { tracking_number: `DYN-${Date.now()}` },
      labels: [],
    }
  }
}
```

**è´¹æ›¼è§£è¯»**ï¼šè¿™ä¸ª Provider å°±åƒä¸€ä¸ªæ™ºèƒ½è¿è´¹è®¡ç®—å™¨ã€‚ä½ å‘Šè¯‰å®ƒ"æˆ‘è¦å¯„è¿™äº›å•†å“åˆ°ç¾å›½"ï¼Œå®ƒæŸ¥è¡¨ç®—å‡ºè¿è´¹ã€‚ä¸åŒå•†å“ã€ä¸åŒå›½å®¶ï¼Œè¿è´¹ä¸åŒã€‚æ²¡åœ¨è¡¨é‡Œçš„å•†å“ï¼Ÿå…è¿è´¹ã€‚

**è®¾è®¡åŸåˆ™**ï¼š

```
PRODUCT_SHIPPING_RATES = {
  "cs-737x-tq": {     // å•†å“ handle
    us: 100,           // ç¾å›½ $1.00ï¼ˆå•ä½æ˜¯åˆ†ï¼‰
    eu: 200,           // æ¬§æ´² $2.00
    default: 200,      // å…¶ä»–åœ°åŒº
  },
}
```

é‡‘é¢å•ä½æ˜¯**åˆ†ï¼ˆcentsï¼‰**ï¼Œä¸æ˜¯å…ƒã€‚è¿™æ˜¯æ‰€æœ‰ç”µå•†ç³»ç»Ÿå¤„ç†è´§å¸çš„æ ‡å‡†åšæ³•â€”â€”é¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ã€‚`100` è¡¨ç¤º $1.00ã€‚

---

## ç¬¬å››ç« ï¼šæ•°æ®æµå…¨æ™¯â€”â€”ä¸€ä¸ªè®¢å•çš„ä¸€ç”Ÿ

### ç”¨è´¹æ›¼çš„æ–¹å¼è¿½è¸ªä¸€ä¸ªå®Œæ•´è´­ç‰©æµç¨‹

è®©æˆ‘ä»¬è·Ÿè¸ªä¸€ä¸ªçœŸå®è¯·æ±‚ï¼Œä»ç”¨æˆ·æ‰“å¼€å•†å“é¡µåˆ°æ”¶åˆ°ç¡®è®¤é‚®ä»¶ï¼Œæ¯ä¸€æ­¥åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚

```
ç”¨æˆ·è¡Œä¸º                å‰ç«¯ï¼ˆNext.jsï¼‰           åç«¯ï¼ˆMedusaï¼‰            æ•°æ®åº“/Redis
  â”‚                         â”‚                         â”‚                       â”‚
  â”‚  æ‰“å¼€å•†å“é¡µ              â”‚                         â”‚                       â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                         â”‚                       â”‚
  â”‚                         â”‚  GET /store/products     â”‚                       â”‚
  â”‚                         â”‚  ?handle=cs-737x-tq      â”‚                       â”‚
  â”‚                         â”‚  &region_id=xxx          â”‚                       â”‚
  â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                       â”‚
  â”‚                         â”‚                         â”‚  SELECT * FROM product â”‚
  â”‚                         â”‚                         â”‚  JOIN price_set       â”‚
  â”‚                         â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ > â”‚
  â”‚                         â”‚                         â”‚  <â”€â”€ è¿”å›å•†å“+ä»·æ ¼     â”‚
  â”‚                         â”‚  <â”€â”€ æ¸²æŸ“å•†å“è¯¦æƒ…é¡µ       â”‚                       â”‚
  â”‚  <â”€â”€ çœ‹åˆ°å•†å“é¡µé¢         â”‚                         â”‚                       â”‚
  â”‚                         â”‚                         â”‚                       â”‚
  â”‚  ç‚¹å‡»"åŠ å…¥è´­ç‰©è½¦"        â”‚                         â”‚                       â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                         â”‚                       â”‚
  â”‚                         â”‚  Server Action:          â”‚                       â”‚
  â”‚                         â”‚  addToCart()             â”‚                       â”‚
  â”‚                         â”‚    â†“                     â”‚                       â”‚
  â”‚                         â”‚  getOrSetCart()          â”‚                       â”‚
  â”‚                         â”‚  ï¼ˆå¦‚æœæ²¡æœ‰è´­ç‰©è½¦â†’åˆ›å»ºï¼‰    â”‚                       â”‚
  â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                       â”‚
  â”‚                         â”‚  POST /store/carts       â”‚                       â”‚
  â”‚                         â”‚  POST /store/carts/{id}  â”‚                       â”‚
  â”‚                         â”‚    /line-items           â”‚                       â”‚
  â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                       â”‚
  â”‚                         â”‚                         â”‚  INSERT INTO cart_item â”‚
  â”‚                         â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ > â”‚
  â”‚                         â”‚  <â”€â”€ è´­ç‰©è½¦å·²æ›´æ–°         â”‚                       â”‚
  â”‚  <â”€â”€ çœ‹åˆ°è´­ç‰©è½¦æ•°é‡+1     â”‚                         â”‚                       â”‚
  â”‚                         â”‚                         â”‚                       â”‚
  â”‚  ç»“è´¦ â†’ å¡«å†™åœ°å€ â†’ é€‰è¿è´¹ â”‚                         â”‚                       â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                         â”‚                       â”‚
  â”‚                         â”‚  POST /store/carts/{id}  â”‚                       â”‚
  â”‚                         â”‚  (æ›´æ–°åœ°å€)               â”‚                       â”‚
  â”‚                         â”‚  GET /store/shipping-    â”‚                       â”‚
  â”‚                         â”‚  options?cart_id={id}    â”‚                       â”‚
  â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                       â”‚
  â”‚                         â”‚                         â”‚  DynamicShipping       â”‚
  â”‚                         â”‚                         â”‚  .calculatePrice()     â”‚
  â”‚                         â”‚                         â”‚  â†’ æŸ¥è¡¨ç®—è¿è´¹          â”‚
  â”‚                         â”‚  <â”€â”€ è¿”å›è¿è´¹é€‰é¡¹         â”‚                       â”‚
  â”‚                         â”‚                         â”‚                       â”‚
  â”‚  é€‰æ‹©æ”¯ä»˜æ–¹å¼ â†’ ç¡®è®¤æ”¯ä»˜  â”‚                         â”‚                       â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                         â”‚                       â”‚
  â”‚                         â”‚  completeCart()          â”‚                       â”‚
  â”‚                         â”‚  POST /store/carts/{id}  â”‚                       â”‚
  â”‚                         â”‚    /complete             â”‚                       â”‚
  â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                       â”‚
  â”‚                         â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚                         â”‚                         â”‚  â”‚   Workflow:      â”‚  â”‚
  â”‚                         â”‚                         â”‚  â”‚  1. éªŒè¯åº“å­˜     â”‚  â”‚
  â”‚                         â”‚                         â”‚  â”‚  2. å¤„ç†æ”¯ä»˜     â”‚  â”‚
  â”‚                         â”‚                         â”‚  â”‚  3. åˆ›å»ºè®¢å•     â”‚  â”‚
  â”‚                         â”‚                         â”‚  â”‚  4. æ‰£å‡åº“å­˜     â”‚  â”‚
  â”‚                         â”‚                         â”‚  â”‚  5. å‘å°„äº‹ä»¶     â”‚  â”‚
  â”‚                         â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                         â”‚                         â”‚           â”‚           â”‚
  â”‚                         â”‚                         â”‚  Event: "order.placed" â”‚
  â”‚                         â”‚                         â”‚           â”‚           â”‚
  â”‚                         â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚                         â”‚                         â”‚  â”‚  Subscriber:     â”‚  â”‚
  â”‚                         â”‚                         â”‚  â”‚  order-placed.ts â”‚  â”‚
  â”‚                         â”‚                         â”‚  â”‚  â†’ å‘ç¡®è®¤é‚®ä»¶    â”‚  â”‚
  â”‚                         â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                         â”‚  <â”€â”€ { type: "order",   â”‚                       â”‚
  â”‚                         â”‚       order: {...} }     â”‚                       â”‚
  â”‚  <â”€â”€ çœ‹åˆ°"è®¢å•å·²ç¡®è®¤"    â”‚                         â”‚                       â”‚
  â”‚  ğŸ“§ æ”¶åˆ°ç¡®è®¤é‚®ä»¶          â”‚                         â”‚                       â”‚
```

### æ¯ä¸€æ­¥çš„ä»£ç å¯¹ç…§

#### Step 1ï¼šè·å–å•†å“

å‰ç«¯ `products.ts` é€šè¿‡ Medusa JS SDK è·å–å•†å“ï¼š

```typescript
// apps/dji-storefront/src/lib/data/products.ts

const { products } = await sdk.client.fetch<{
  products: HttpTypes.StoreProduct[]
}>(`/store/products`, {
  method: "GET",
  query: {
    handle,
    region_id: region?.id,    // æ ¹æ®åœ°åŒºè¿”å›å¯¹åº”è´§å¸çš„ä»·æ ¼
    fields: "+variants.inventory_quantity,+variants.calculated_price",
  },
  headers,
})
```

**å…³é”®æ¦‚å¿µâ€”â€”Regionï¼ˆåœ°åŒºï¼‰**ï¼šåŒä¸€ä¸ªå•†å“åœ¨ä¸åŒåœ°åŒºæ˜¾ç¤ºä¸åŒçš„è´§å¸å’Œä»·æ ¼ã€‚`region_id` å‘Šè¯‰ Medusa "ç”¨å“ªä¸ªåœ°åŒºçš„ä»·æ ¼ä½“ç³»"ã€‚

#### Step 2ï¼šåŠ å…¥è´­ç‰©è½¦

```typescript
// apps/dji-storefront/src/lib/data/cart.ts

export const addToCart = async ({ variantId, quantity, countryCode }) => {
  // 1. è·å–æˆ–åˆ›å»ºè´­ç‰©è½¦ï¼ˆç¡®ä¿ç»‘å®šäº†æ­£ç¡®çš„ Regionï¼‰
  const cart = await getOrSetCart(countryCode)

  // 2. æ·»åŠ è¡Œé¡¹ç›®
  await sdk.store.cart.createLineItem(
    cart.id,
    { variant_id: variantId, quantity },
    undefined,
    headers
  )

  // 3. è®© Next.js åˆ·æ–°ç¼“å­˜
  await revalidateCart()
}
```

**å…³é”®æ¦‚å¿µâ€”â€”Cart çš„ Region ç»‘å®š**ï¼šè´­ç‰©è½¦åˆ›å»ºæ—¶å°±ç»‘å®šäº†ä¸€ä¸ª Regionã€‚è¿™å†³å®šäº†ï¼š
- æ˜¾ç¤ºä»€ä¹ˆè´§å¸
- è®¡ç®—ä»€ä¹ˆç¨ç‡
- å¯ä»¥é€‰å“ªäº›é…é€æ–¹å¼

å¦‚æœç”¨æˆ·åˆ‡æ¢å›½å®¶ï¼Œä»£ç ä¼šè‡ªåŠ¨æ›´æ–° Cart çš„ Regionï¼š

```typescript
if (cart.region_id !== regionConfig.id) {
  cart = (await sdk.store.cart.update(cart.id, { region_id: regionConfig.id })).cart
}
```

#### Step 3ï¼šè®¢å•å®Œæˆåçš„äº‹ä»¶é“¾

å½“ `order.placed` äº‹ä»¶è¢«è§¦å‘ï¼ŒSubscriber è‡ªåŠ¨æ‰§è¡Œï¼š

```typescript
// apps/medusa/src/subscribers/order-placed.ts

export default async function orderPlacedHandler({ event: { data }, container }) {
  // 1. é€šè¿‡ Query API è·å–å®Œæ•´è®¢å•æ•°æ®
  const { data: [order] } = await query.graph({
    entity: "order",
    fields: [
      "id", "display_id", "email",
      "items.*", "items.variant.*", "items.variant.product.*",
      "shipping_address.*", "total",
    ],
    filters: { id: data.id },
  })

  // 2. é€šè¿‡ Notification æ¨¡å—å‘é€é‚®ä»¶
  await notificationModuleService.createNotifications({
    to: order.email,
    channel: "email",
    template: "order-placed",     // å¯¹åº” Resend Provider é‡Œçš„æ¨¡æ¿
    data: { order: { ... } },     // ä¼ ç»™é‚®ä»¶æ¨¡æ¿çš„æ•°æ®
  })
}

export const config: SubscriberConfig = {
  event: "order.placed",           // ç›‘å¬è¿™ä¸ªäº‹ä»¶
}
```

**å…³é”®æ¦‚å¿µâ€”â€”Query API**ï¼šMedusa 2.x çš„ `query.graph()` æ˜¯ä¸€ä¸ªç±» GraphQL çš„æŸ¥è¯¢æ¥å£ã€‚ä½ å£°æ˜è¦ä»€ä¹ˆå­—æ®µï¼Œå®ƒè‡ªåŠ¨å¤„ç†è·¨æ¨¡å—çš„æ•°æ®æ‹¼æ¥ï¼ˆæ¯”å¦‚åŒæ—¶è·å–è®¢å•ã€å•†å“ã€åœ°å€ä¿¡æ¯ï¼‰ã€‚

---

## ç¬¬äº”ç« ï¼šå››å¤§æ‰©å±•æœºåˆ¶â€”â€”å¦‚ä½•è®© Medusa åšä½ æƒ³åšçš„äº‹

Medusa æä¾›äº† 4 ç§ä¸»è¦çš„æ‰©å±•æ–¹å¼ã€‚ç”¨ä¸€ä¸ªç±»æ¯”ç†æ¸…å®ƒä»¬çš„å…³ç³»ï¼š

```
å‡è®¾ Medusa æ˜¯ä¸€æ ‹åŠå…¬æ¥¼ï¼š

1. API Route    = å¤§æ¥¼çš„"æ–°å…¥å£"ï¼ˆç»™å¤–ç•Œæ–°çš„è®¿é—®æ–¹å¼ï¼‰
2. Subscriber   = å¤§æ¥¼çš„"å¹¿æ’­ç›‘å¬å‘˜"ï¼ˆå¬åˆ°å¹¿æ’­å°±æ‰§è¡Œä»»åŠ¡ï¼‰
3. Module/Provider = å¤§æ¥¼çš„"æ–°éƒ¨é—¨"ï¼ˆæä¾›æ–°çš„æœåŠ¡èƒ½åŠ›ï¼‰
4. Workflow     = å¤§æ¥¼çš„"SOP æµç¨‹å›¾"ï¼ˆå¤šæ­¥éª¤æ“ä½œçš„ç¼–æ’ï¼‰
```

### æ‰©å±•æœºåˆ¶ 1ï¼šè‡ªå®šä¹‰ API Route

**æ˜¯ä»€ä¹ˆ**ï¼šç»™ Medusa æ·»åŠ æ–°çš„ HTTP ç«¯ç‚¹ã€‚

**ä»€ä¹ˆæ—¶å€™ç”¨**ï¼šå½“ä½ éœ€è¦ Medusa æ ‡å‡† API ä¹‹å¤–çš„æ¥å£ã€‚

æœ¬é¡¹ç›®çš„ OTP ç™»å½•å°±æ˜¯æœ€å¥½çš„ä¾‹å­ï¼š

```
src/api/
â”œâ”€â”€ store/
â”‚   â””â”€â”€ auth/
â”‚       â””â”€â”€ otp/
â”‚           â”œâ”€â”€ initiate/route.ts   â†’ POST /store/auth/otp/initiate
â”‚           â”œâ”€â”€ verify/route.ts     â†’ POST /store/auth/otp/verify
â”‚           â”œâ”€â”€ complete/route.ts   â†’ POST /store/auth/otp/complete
â”‚           â””â”€â”€ resend/route.ts     â†’ POST /store/auth/otp/resend
```

**æ–‡ä»¶è·¯å¾„å³ URL**ï¼šè¿™æ˜¯ Medusa çš„çº¦å®šã€‚`src/api/store/auth/otp/initiate/route.ts` è‡ªåŠ¨æ˜ å°„ä¸º `POST /store/auth/otp/initiate`ã€‚ç±»ä¼¼ Next.js çš„æ–‡ä»¶è·¯ç”±ã€‚

è·¯ç”±æ–‡ä»¶çš„ç»“æ„ï¼š

```typescript
// apps/medusa/src/api/store/auth/otp/initiate/route.ts

import type { MedusaRequest, MedusaResponse } from "@medusajs/framework/http"
import { Modules } from "@medusajs/framework/utils"

export const POST = async (req: MedusaRequest, res: MedusaResponse) => {
  const { email } = req.body

  // 1. é€šè¿‡ä¾èµ–æ³¨å…¥è·å–æ¨¡å—æœåŠ¡
  const customerService = req.scope.resolve(Modules.CUSTOMER)

  // 2. ä¸šåŠ¡é€»è¾‘
  const [existingCustomer] = await customerService.listCustomers(
    { email: normalizedEmail },
    { take: 1 }
  )
  const otp = generateOTP()   // ç”Ÿæˆ 6 ä½éªŒè¯ç 

  // 3. å­˜å…¥ Redisï¼ˆ10 åˆ†é’Ÿè¿‡æœŸï¼‰
  await withDedicatedRedis(async (redis) => {
    await redis.setex(redisKey, 600, JSON.stringify(pendingData))
  })

  // 4. å‘é€é‚®ä»¶
  const notificationService = req.scope.resolve(Modules.NOTIFICATION)
  await notificationService.createNotifications({
    to: email,
    channel: "email",
    template: "otp-verification",
    data: { otp_code: otp },
  })

  return res.status(200).json({ success: true })
}
```

**å…³é”®æ¦‚å¿µâ€”â€”ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰**ï¼š

```typescript
const customerService = req.scope.resolve(Modules.CUSTOMER)
```

ä½ ä¸éœ€è¦ `new CustomerService()`ã€‚Medusa çš„å®¹å™¨è‡ªåŠ¨ç®¡ç†æ‰€æœ‰æœåŠ¡å®ä¾‹ã€‚ä½ åªéœ€è¦"è¦"ï¼Œå®ƒå°±ç»™ä½ ã€‚è¿™å°±åƒåœ¨å…¬å¸é‡Œï¼Œä½ ä¸éœ€è¦è‡ªå·±å»º IT éƒ¨é—¨ï¼Œå‘ä¸ªé‚®ä»¶ç»™ IT å°±è¡Œã€‚

### æ‰©å±•æœºåˆ¶ 2ï¼šSubscriberï¼ˆäº‹ä»¶è®¢é˜…è€…ï¼‰

**æ˜¯ä»€ä¹ˆ**ï¼šç›‘å¬ç³»ç»Ÿäº‹ä»¶ï¼Œè‡ªåŠ¨æ‰§è¡Œé€»è¾‘ã€‚

**è´¹æ›¼ç±»æ¯”**ï¼šå°±åƒæ‰‹æœºçš„æ¨é€é€šçŸ¥è®¢é˜…ã€‚ä½ è®¢é˜…äº†å¤©æ°”æé†’ï¼Œå¤©æ°”å˜åŒ–æ—¶è‡ªåŠ¨æ”¶åˆ°é€šçŸ¥ã€‚

æœ¬é¡¹ç›®æœ‰ 5 ä¸ª Subscriberï¼š

```
src/subscribers/
â”œâ”€â”€ customer-created.ts    â†’ æ–°ç”¨æˆ·æ³¨å†Œ â†’ å‘æ¬¢è¿é‚®ä»¶
â”œâ”€â”€ order-placed.ts        â†’ ä¸‹å•æˆåŠŸ â†’ å‘ç¡®è®¤é‚®ä»¶
â”œâ”€â”€ order-shipped.ts       â†’ å‘è´§ â†’ å‘ç‰©æµé€šçŸ¥
â”œâ”€â”€ password-reset.ts      â†’ å¯†ç é‡ç½® â†’ å‘é‡ç½®é“¾æ¥
â””â”€â”€ discourse-sync.ts      â†’ ç”¨æˆ·å˜æ›´ â†’ åŒæ­¥åˆ°è®ºå›
```

Subscriber çš„ä»£ç æ¨¡å¼æå…¶ç®€æ´ï¼š

```typescript
// apps/medusa/src/subscribers/customer-created.ts

export default async function customerCreatedHandler({
  event: { data },    // äº‹ä»¶æºå¸¦çš„æ•°æ®ï¼ˆæ¯”å¦‚å®¢æˆ· IDï¼‰
  container,          // ä¾èµ–æ³¨å…¥å®¹å™¨
}) {
  const query = container.resolve("query")
  const notificationService = container.resolve(Modules.NOTIFICATION)

  // è·å–å®¢æˆ·ä¿¡æ¯
  const { data: [customer] } = await query.graph({
    entity: "customer",
    fields: ["id", "email", "first_name"],
    filters: { id: data.id },
  })

  // å‘é€æ¬¢è¿é‚®ä»¶
  await notificationService.createNotifications({
    to: customer.email,
    channel: "email",
    template: "customer-created",
    data: { first_name: customer.first_name },
  })
}

export const config: SubscriberConfig = {
  event: "customer.created",   // ç›‘å¬ä»€ä¹ˆäº‹ä»¶
}
```

**é‡è¦åŸåˆ™â€”â€”Subscriber åº”è¯¥æ˜¯"Fire and Forget"**ï¼š
- Subscriber ä¸åº”è¯¥é˜»å¡ä¸»æµç¨‹
- Subscriber å¤±è´¥ä¸åº”è¯¥å¯¼è‡´ä¸»æ“ä½œå¤±è´¥
- å‘é‚®ä»¶å¤±è´¥äº†ï¼Ÿè®°ä¸ªæ—¥å¿—å°±å¥½ï¼Œä¸è¦è®©ç”¨æˆ·ä¸‹å•å¤±è´¥

çœ‹ Discourse åŒæ­¥ Subscriber çš„åšæ³•â€”â€”å®Œç¾ä½“ç°äº†è¿™ä¸ªåŸåˆ™ï¼š

```typescript
// apps/medusa/src/subscribers/discourse-sync.ts

// å¦‚æœ Discourse ç¯å¢ƒå˜é‡æ²¡é…ç½®ï¼Œé™é»˜è·³è¿‡
if (!DISCOURSE_URL || !DISCOURSE_SSO_SECRET || !DISCOURSE_API_KEY) {
  return  // ä¸æŠ¥é”™ï¼Œç›´æ¥è¿”å›
}

// åŒæ­¥å¤±è´¥ä¹Ÿä¸å½±å“ä¸»æµç¨‹
try {
  await fetch(`${DISCOURSE_URL}/admin/users/sync_sso`, { ... })
} catch (error) {
  console.warn("Discourse sync failed:", error)  // warn è€Œé error
}
```

### æ‰©å±•æœºåˆ¶ 3ï¼šè‡ªå®šä¹‰ Module/Provider

å·²åœ¨ç¬¬ä¸‰ç« è¯¦ç»†è®²è§£ã€‚æ€»ç»“ä¸€ä¸‹å…³é”®ç‚¹ï¼š

| åˆ›å»ºåœºæ™¯ | æ‰©å±•ä»€ä¹ˆ | åŸºç±» |
|---------|---------|------|
| æ–°çš„æ”¯ä»˜æ–¹å¼ | Payment Provider | `AbstractPaymentProviderService` |
| æ–°çš„ç‰©æµæ–¹å¼ | Fulfillment Provider | `AbstractFulfillmentProviderService` |
| æ–°çš„ç™»å½•æ–¹å¼ | Auth Provider | `AbstractAuthModuleProvider` |
| æ–°çš„é€šçŸ¥æ¸ é“ | Notification Provider | `AbstractNotificationProviderService` |
| æ–°çš„æ–‡ä»¶å­˜å‚¨ | File Provider | `AbstractFileProviderService` |

æœ¬é¡¹ç›®åˆ›å»ºäº† 5 ä¸ªè‡ªå®šä¹‰ Providerï¼š

```
src/modules/
â”œâ”€â”€ auth-discord/          â†’ Discord OAuth ç™»å½•
â”œâ”€â”€ auth-facebook/         â†’ Facebook OAuth ç™»å½•
â”œâ”€â”€ auth-google-one-tap/   â†’ Google One Tap ç™»å½•
â”œâ”€â”€ dynamic-shipping/      â†’ åŠ¨æ€è¿è´¹è®¡ç®—
â””â”€â”€ resend-notification/   â†’ Resend é‚®ä»¶å‘é€
```

### æ‰©å±•æœºåˆ¶ 4ï¼šWorkflow

**æ˜¯ä»€ä¹ˆ**ï¼šç¼–æ’å¤šæ­¥éª¤æ“ä½œï¼Œæ”¯æŒäº‹åŠ¡å›æ»šã€‚

**è´¹æ›¼ç±»æ¯”**ï¼šå°±åƒé“¶è¡Œè½¬è´¦ã€‚"A è´¦æˆ·æ‰£ 100 â†’ B è´¦æˆ·åŠ  100"ã€‚å¦‚æœç¬¬äºŒæ­¥å¤±è´¥ï¼Œç¬¬ä¸€æ­¥å¿…é¡»æ’¤é”€ã€‚Workflow å°±æ˜¯ç¡®ä¿è¿™ç§å¤šæ­¥éª¤æ“ä½œçš„ä¸€è‡´æ€§ã€‚

æœ¬é¡¹ç›®ä½¿ç”¨ Medusa å†…ç½®çš„ Workflowï¼ˆ`@medusajs/medusa/core-flows`ï¼‰ï¼Œåœ¨ seed è„šæœ¬ä¸­å¯ä»¥çœ‹åˆ°ï¼š

```typescript
// apps/medusa/src/scripts/seed.ts

import {
  createSalesChannelsWorkflow,
  createRegionsWorkflow,
  createProductsWorkflow,
  createInventoryLevelsWorkflow,
  // ...
} from "@medusajs/medusa/core-flows"

// Workflow çš„ä½¿ç”¨ï¼šè·å–å®¹å™¨ â†’ è¿è¡Œ
const { result } = await createRegionsWorkflow(container).run({
  input: {
    regions: [{
      name: "Europe",
      currency_code: "eur",
      countries: ["gb", "de", "dk", "se", "fr", "es", "it"],
      payment_providers: ["pp_system_default"],
    }],
  },
})
```

**ä»€ä¹ˆæ—¶å€™éœ€è¦è‡ªå®šä¹‰ Workflowï¼Ÿ**
- å½“ä½ æœ‰å¤šä¸ªæ­¥éª¤éœ€è¦åŸå­æ€§æ‰§è¡Œ
- å½“æŸä¸€æ­¥å¤±è´¥éœ€è¦å›æ»šå‰é¢çš„æ­¥éª¤
- å½“ä½ éœ€è¦ç¼–æ’å¤æ‚çš„ä¸šåŠ¡æµç¨‹

æœ¬é¡¹ç›®ç›®å‰æ²¡æœ‰è‡ªå®šä¹‰ Workflowï¼ˆ`src/workflows/` ç›®å½•ä¸ºç©ºï¼‰ï¼Œå› ä¸ºå†…ç½® Workflow å·²ç»è¦†ç›–äº†æ‰€æœ‰éœ€æ±‚ã€‚

---

## ç¬¬å…­ç« ï¼šå‰åç«¯é›†æˆâ€”â€”Next.js å¦‚ä½•ä¸ Medusa å¯¹è¯

### é€šä¿¡æ–¹å¼å…¨æ™¯

```
                    Next.js (dji-storefront)
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚                  â”‚
    React Server       Server Actions      API Routes
    Components         (mutations)         (webhooks)
            â”‚              â”‚                  â”‚
            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
            â”‚    â”‚  Medusa JS SDK    â”‚        â”‚
            â”‚    â”‚  (sdk.client)     â”‚        â”‚
            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
            â”‚              â”‚                  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    REST API (HTTP)
                           â”‚
                    Medusa Backend
                    (localhost:9000)
```

### ä¸‰ç§é€šä¿¡æ¨¡å¼

#### æ¨¡å¼ 1ï¼šServer Component è¯»å–æ•°æ®

```typescript
// apps/dji-storefront/src/app/[countryCode]/products/page.tsx

// è¿™æ˜¯ä¸€ä¸ª React Server Componentï¼ˆæ²¡æœ‰ "use client"ï¼‰
export default async function ProductsPage({ params }) {
  const { countryCode } = await params

  // ç›´æ¥åœ¨æœåŠ¡ç«¯è°ƒç”¨ Medusa APIï¼ˆä¸æš´éœ²ç»™æµè§ˆå™¨ï¼‰
  const products = await getProducts({ countryCode, limit: 100 })

  return <ProductsPageClient products={products} />
}
```

**ä¸ºä»€ä¹ˆç”¨ Server Componentï¼Ÿ**
- API Key å’Œè®¤è¯ Token ä¸ä¼šæš´éœ²ç»™æµè§ˆå™¨
- æœåŠ¡ç«¯åˆ° Medusa çš„è¯·æ±‚å»¶è¿Ÿæä½ï¼ˆåŒæœºæˆ¿/åŒæœåŠ¡å™¨ï¼‰
- SEO å‹å¥½ï¼ˆHTML åœ¨æœåŠ¡ç«¯å·²ç»æ¸²æŸ“å¥½ï¼‰

#### æ¨¡å¼ 2ï¼šServer Action å¤„ç†ç”¨æˆ·æ“ä½œ

```typescript
// apps/dji-storefront/src/app/actions/cart.ts

"use server"  // æ ‡è®°ä¸º Server Action

export async function addToCartAction({ variantId, quantity, countryCode }) {
  try {
    await addToCart({ variantId, quantity, countryCode })
    revalidatePath("/", "layout")   // é€šçŸ¥ Next.js åˆ·æ–° UI
    return { success: true }
  } catch (error) {
    return { success: false, error: error.message }
  }
}
```

å‰ç«¯ç»„ä»¶è°ƒç”¨ï¼š

```typescript
// åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­
const result = await addToCartAction({
  variantId: variant.id,
  quantity,
  countryCode,
})
```

**ä¸ºä»€ä¹ˆç”¨ Server Actionï¼Ÿ**
- ç”¨æˆ·æ“ä½œï¼ˆåŠ è´­ç‰©è½¦ã€ä¸‹å•ï¼‰éœ€è¦å‘é€æ•°æ®ç»™æœåŠ¡ç«¯
- Server Action è‡ªåŠ¨å¤„ç† CSRF é˜²æŠ¤
- æ•æ„Ÿæ“ä½œï¼ˆæ‰£æ¬¾ã€è®¤è¯ï¼‰åœ¨æœåŠ¡ç«¯æ‰§è¡Œæ›´å®‰å…¨

#### æ¨¡å¼ 3ï¼šAPI Route å¤„ç†å¤–éƒ¨å›è°ƒ

```typescript
// apps/dji-storefront/src/app/api/auth/callback/google/route.ts

export async function GET(request: NextRequest) {
  const code = request.nextUrl.searchParams.get("code")
  // å¤„ç† Google OAuth å›è°ƒ
  // äº¤æ¢ token â†’ éªŒè¯ç”¨æˆ· â†’ è®¾ç½® cookie
}
```

**ä¸ºä»€ä¹ˆç”¨ API Routeï¼Ÿ**
- OAuth å›è°ƒéœ€è¦ä¸€ä¸ªçœŸå®çš„ URLï¼ˆGoogle ä¼šé‡å®šå‘åˆ°è¿™ä¸ªåœ°å€ï¼‰
- Webhook éœ€è¦ä¸€ä¸ªå¯ä»¥æ¥æ”¶ POST è¯·æ±‚çš„ç«¯ç‚¹
- è¿™äº›åœºæ™¯ä¸é€‚åˆ Server Actionï¼ˆå®ƒä»¬ç”±å¤–éƒ¨ç³»ç»Ÿè§¦å‘ï¼Œä¸æ˜¯ç”¨æˆ·ç‚¹å‡»è§¦å‘ï¼‰

### æ•°æ®æ˜ å°„å±‚â€”â€”å¼¥åˆå‰åç«¯çš„æ•°æ®å·®å¼‚

Medusa API è¿”å›çš„æ•°æ®ç»“æ„å’Œå‰ç«¯éœ€è¦çš„ä¸å®Œå…¨ä¸€è‡´ã€‚æœ¬é¡¹ç›®é€šè¿‡ `mapStoreProduct` å‡½æ•°åšè½¬æ¢ï¼š

```typescript
// apps/dji-storefront/src/lib/data/products.ts

const mapStoreProduct = (product: HttpTypes.StoreProduct): StorefrontProduct => {
  // Medusa è¿”å›çš„ä»·æ ¼åœ¨ variant.calculated_price.calculated_amount
  // å‰ç«¯éœ€è¦çš„æ˜¯ç®€å•çš„ product.price æ•°å­—

  const cheapestVariant = productVariants
    .filter(v => Boolean(v.calculated_price))
    .sort((a, b) => a.calculated_price.calculated_amount - b.calculated_price.calculated_amount)
    [0]

  return {
    id: product.id,
    handle: product.handle,
    title: product.title,
    price: cheapestVariant?.calculated_price?.calculated_amount ?? 0,
    images: buildImageGallery(product.thumbnail, product.images),
    variants: productVariants.map(v => ({
      id: v.id,
      title: v.title,
      price: v.calculated_price?.calculated_amount ?? 0,
      inStock: (v.inventory_quantity ?? 0) > 0,
    })),
    // ... æ›´å¤šå­—æ®µ
  }
}
```

**è´¹æ›¼ç†è§£**ï¼šè¿™å°±åƒç¿»è¯‘å®˜ã€‚Medusa è¯´æ³•è¯­ï¼ˆåµŒå¥—çš„å¤æ‚ç»“æ„ï¼‰ï¼Œå‰ç«¯è¯´ä¸­æ–‡ï¼ˆæ‰å¹³çš„ç®€å•ç»“æ„ï¼‰ï¼Œ`mapStoreProduct` åœ¨ä¸­é—´ç¿»è¯‘ã€‚

---

## ç¬¬ä¸ƒç« ï¼šè®¤è¯ä½“ç³»â€”â€”ä» OTP åˆ° OAuth çš„å…¨é“¾è·¯

### è®¤è¯çš„ç¬¬ä¸€æ€§åŸç†

**é—®é¢˜çš„æœ¬è´¨**ï¼šå¦‚ä½•è¯æ˜"ä½ æ˜¯ä½ "ï¼Ÿ

åªæœ‰ä¸‰ç§æ–¹å¼ï¼š
1. **ä½ çŸ¥é“ä»€ä¹ˆ**ï¼ˆå¯†ç ã€éªŒè¯ç ï¼‰
2. **ä½ æœ‰ä»€ä¹ˆ**ï¼ˆæ‰‹æœºã€ç¡¬ä»¶ Keyï¼‰
3. **ä½ æ˜¯ä»€ä¹ˆ**ï¼ˆæŒ‡çº¹ã€äººè„¸ï¼‰

æœ¬é¡¹ç›®å®ç°äº†å‰ä¸¤ç§çš„å¤šç§ç»„åˆï¼š

```
è®¤è¯æ–¹å¼                      "ä½ çŸ¥é“ä»€ä¹ˆ"           "ä½ æœ‰ä»€ä¹ˆ"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Email + Password             å¯†ç                   â€”
OTP (ä¸€æ¬¡æ€§éªŒè¯ç )            â€”                    æ‰‹æœº/é‚®ç®±
Google One Tap               â€”                    Google è´¦å·
Google OAuth                 â€”                    Google è´¦å·
Discord OAuth                â€”                    Discord è´¦å·
Facebook OAuth               â€”                    Facebook è´¦å·
```

### è®¤è¯æµç¨‹å›¾

#### OTP ç™»å½•æµç¨‹ï¼ˆæœ€å®Œæ•´ï¼Œä¹Ÿæœ€èƒ½è¯´æ˜é—®é¢˜ï¼‰

```
ç”¨æˆ·                 å‰ç«¯                 Medusa API              Redis           é‚®ä»¶æœåŠ¡
 â”‚                   â”‚                     â”‚                      â”‚                â”‚
 â”‚  è¾“å…¥é‚®ç®±          â”‚                     â”‚                      â”‚                â”‚
 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                     â”‚                      â”‚                â”‚
 â”‚                   â”‚  POST /store/auth/   â”‚                      â”‚                â”‚
 â”‚                   â”‚  otp/initiate        â”‚                      â”‚                â”‚
 â”‚                   â”‚  { email }           â”‚                      â”‚                â”‚
 â”‚                   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                      â”‚                â”‚
 â”‚                   â”‚                     â”‚  æŸ¥è¯¢ Customer       â”‚                â”‚
 â”‚                   â”‚                     â”‚  â†’ å­˜åœ¨/ä¸å­˜åœ¨        â”‚                â”‚
 â”‚                   â”‚                     â”‚                      â”‚                â”‚
 â”‚                   â”‚                     â”‚  ç”Ÿæˆ6ä½OTP           â”‚                â”‚
 â”‚                   â”‚                     â”‚  SETEX otp:auth:     â”‚                â”‚
 â”‚                   â”‚                     â”‚  {email} 600ç§’       â”‚                â”‚
 â”‚                   â”‚                     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                â”‚
 â”‚                   â”‚                     â”‚                      â”‚                â”‚
 â”‚                   â”‚                     â”‚  å‘é€OTPé‚®ä»¶          â”‚                â”‚
 â”‚                   â”‚                     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ > â”‚
 â”‚                   â”‚                     â”‚                      â”‚                â”‚
 â”‚                   â”‚  <â”€â”€ { isNewUser }   â”‚                      â”‚                â”‚
 â”‚  <â”€â”€ æ˜¾ç¤ºOTPè¾“å…¥æ¡† â”‚                     â”‚                      â”‚                â”‚
 â”‚                   â”‚                     â”‚                      â”‚                â”‚
 â”‚  è¾“å…¥éªŒè¯ç         â”‚                     â”‚                      â”‚                â”‚
 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                     â”‚                      â”‚                â”‚
 â”‚                   â”‚  POST /store/auth/   â”‚                      â”‚                â”‚
 â”‚                   â”‚  otp/verify          â”‚                      â”‚                â”‚
 â”‚                   â”‚  { email, otp }      â”‚                      â”‚                â”‚
 â”‚                   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                      â”‚                â”‚
 â”‚                   â”‚                     â”‚  GET otp:auth:{email} â”‚               â”‚
 â”‚                   â”‚                     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                â”‚
 â”‚                   â”‚                     â”‚  <â”€â”€ éªŒè¯OTP           â”‚               â”‚
 â”‚                   â”‚                     â”‚                      â”‚                â”‚
 â”‚                   â”‚                     â”‚  [å¦‚æœæ˜¯è€ç”¨æˆ·]        â”‚                â”‚
 â”‚                   â”‚                     â”‚  â†’ ç”Ÿæˆ JWT Token     â”‚                â”‚
 â”‚                   â”‚                     â”‚  â†’ è¿”å› token         â”‚                â”‚
 â”‚                   â”‚                     â”‚                      â”‚                â”‚
 â”‚                   â”‚                     â”‚  [å¦‚æœæ˜¯æ–°ç”¨æˆ·]        â”‚                â”‚
 â”‚                   â”‚                     â”‚  â†’ æ ‡è®° verified=true  â”‚               â”‚
 â”‚                   â”‚                     â”‚  â†’ ç­‰å¾…å®Œå–„èµ„æ–™        â”‚                â”‚
 â”‚                   â”‚                     â”‚                      â”‚                â”‚
 â”‚                   â”‚  <â”€â”€ { token } æˆ–    â”‚                      â”‚                â”‚
 â”‚                   â”‚  <â”€â”€ { requiresProfile } â”‚                  â”‚                â”‚
 â”‚  <â”€â”€ ç™»å½•æˆåŠŸ æˆ–    â”‚                     â”‚                      â”‚                â”‚
 â”‚      è·³è½¬å®Œå–„èµ„æ–™   â”‚                     â”‚                      â”‚                â”‚
```

### å®‰å…¨æœºåˆ¶è®¾è®¡

```typescript
// apps/medusa/src/utils/otp.ts

// 1. OTP ç”Ÿæˆâ€”â€”åŠ å¯†å®‰å…¨çš„éšæœºæ•°
export function generateOTP(): string {
  const buffer = crypto.randomBytes(3)    // ä¸æ˜¯ Math.random()ï¼
  const num = buffer.readUIntBE(0, 3) % 1000000
  return num.toString().padStart(6, "0")  // å§‹ç»ˆ 6 ä½
}

// 2. é˜²æš´åŠ›ç ´è§£
const MAX_OTP_ATTEMPTS = 5       // æœ€å¤šå°è¯• 5 æ¬¡
const OTP_EXPIRY_SECONDS = 600   // 10 åˆ†é’Ÿè¿‡æœŸ
const RESEND_COOLDOWN_SECONDS = 60  // é‡å‘å†·å´ 60 ç§’

// 3. Redis Key å‘½åç©ºé—´éš”ç¦»
export function getAuthOTPKey(email: string) {
  return `otp:auth:${email}`           // ç™»å½•ç”¨
}
export function getOTPKey(email: string) {
  return `otp:register:${email}`       // æ³¨å†Œç”¨
}
```

**ä¸ºä»€ä¹ˆç”¨ Redis è€Œä¸æ˜¯æ•°æ®åº“ï¼Ÿ**
- OTP æ˜¯ä¸´æ—¶æ•°æ®ï¼Œ10 åˆ†é’Ÿåè‡ªåŠ¨è¿‡æœŸï¼ˆRedis çš„ SETEX å¤©ç„¶æ”¯æŒ TTLï¼‰
- OTP éªŒè¯éœ€è¦é«˜é¢‘è¯»å†™ï¼ˆæ¯æ¬¡éªŒè¯éƒ½è¦è¯»+æ›´æ–°å°è¯•æ¬¡æ•°ï¼‰ï¼ŒRedis æ¯” PostgreSQL å¿« 10-100 å€
- OTP ä¸éœ€è¦æŒä¹…åŒ–ï¼ˆæœåŠ¡å™¨é‡å¯åä¸¢å¤±æ²¡å…³ç³»ï¼Œç”¨æˆ·é‡æ–°å‘ä¸€ä¸ªå°±è¡Œï¼‰

### æ¡ä»¶åŒ–çš„è®¤è¯ Provider æ³¨å†Œ

medusa-config.ts ä¸­ä¸€ä¸ªç²¾å¦™çš„è®¾è®¡â€”â€”**åªåœ¨é…ç½®äº†å¿…è¦ç¯å¢ƒå˜é‡æ—¶æ‰æ³¨å†Œ Provider**ï¼š

```typescript
// apps/medusa/medusa-config.ts

const AUTH_PROVIDERS = []

// Email/Passwordï¼šé»˜è®¤å¯ç”¨ï¼Œå¯ä»¥æ˜¾å¼ç¦ç”¨
if (!EMAILPASS_DISABLED) {
  AUTH_PROVIDERS.push({
    resolve: "@medusajs/auth-emailpass",
    id: "emailpass",
  })
}

// Google One Tapï¼šåªéœ€è¦ Client ID
if (GOOGLE_CLIENT_ID) {
  AUTH_PROVIDERS.push({
    resolve: "./src/modules/auth-google-one-tap",
    id: "google-one-tap",
    options: { clientId: GOOGLE_CLIENT_ID },
  })
}

// Discordï¼šéœ€è¦å®Œæ•´çš„ OAuth ä¸‰ä»¶å¥—
if (DISCORD_CLIENT_ID && DISCORD_CLIENT_SECRET && DISCORD_OAUTH_CALLBACK_URL) {
  AUTH_PROVIDERS.push({
    resolve: "./src/modules/auth-discord",
    id: "discord",
    options: { ... },
  })
}
```

**è®¾è®¡åŸåˆ™**ï¼šä¸éœ€è¦çš„åŠŸèƒ½ä¸åŠ è½½ã€‚æœ¬åœ°å¼€å‘æ—¶å¯èƒ½æ²¡æœ‰ Discord å¯†é’¥â€”â€”æ²¡å…³ç³»ï¼ŒMedusa æ­£å¸¸å¯åŠ¨ï¼Œåªæ˜¯æ²¡æœ‰ Discord ç™»å½•ã€‚è¿™å°±æ˜¯**ä¼˜é›…é™çº§ï¼ˆGraceful Degradationï¼‰**ã€‚

---

## ç¬¬å…«ç« ï¼šä»æœ¬åœ°åˆ°ç”Ÿäº§â€”â€”éƒ¨ç½²çš„å®Œæ•´é“¾è·¯

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

```
docker-compose.local.yml
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
 PostgreSQL  Redis
 (port 5432) (port 6379)
    â”‚         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
   â”‚            â”‚
 Medusa      Next.js
 (port 9000) (port 3000)
   â”‚            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å¯åŠ¨æ­¥éª¤ï¼š

```bash
# 1. å¯åŠ¨åŸºç¡€è®¾æ–½
docker compose -f docker-compose.local.yml up -d

# 2. å®‰è£…ä¾èµ–
pnpm install

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp apps/medusa/.env.template apps/medusa/.env
# ç¼–è¾‘ .envï¼Œè‡³å°‘è®¾ç½® DATABASE_URL å’Œ REDIS_URL

# 4. æ•°æ®åº“è¿ç§»ï¼ˆMedusa è‡ªåŠ¨å¤„ç†ï¼‰
pnpm --filter medusa dev

# 5. æ’­ç§ç¤ºä¾‹æ•°æ®ï¼ˆå¯é€‰ï¼‰
pnpm --filter medusa seed

# 6. å¯åŠ¨å‰ç«¯
pnpm --filter dji-storefront dev
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆGCE Dockerï¼‰

```
                    GCE VM (å•å°æœåŠ¡å™¨)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Production (cs-prod)            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ Medusa   â”‚  â”‚ Strapi   â”‚           â”‚  â”‚
â”‚  â”‚  â”‚ :9000    â”‚  â”‚ :1337    â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â”‚       â”‚              â”‚                 â”‚  â”‚
â”‚  â”‚  Network: 172.30.0.0/16               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚              â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       â”‚  Development (cs-dev)          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ Medusa   â”‚  â”‚ Strapi   â”‚           â”‚  â”‚
â”‚  â”‚  â”‚ :9001    â”‚  â”‚ :1338    â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â”‚       â”‚              â”‚                 â”‚  â”‚
â”‚  â”‚  Network: 172.31.0.0/16               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚              â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Host Services                   â”‚  â”‚
â”‚  â”‚  PostgreSQL :5432    Redis :6379       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ HTTPS
          â–¼
    Vercel (å‰ç«¯)
    cockpitsimulator.com
```

### éƒ¨ç½²æ ¸å¿ƒåŸåˆ™

#### åŸåˆ™ 1ï¼šç«¯å£éš”ç¦»

```
ç”Ÿäº§ Medusa â†’ 9000    å¼€å‘ Medusa â†’ 9001
ç”Ÿäº§ Strapi â†’ 1337    å¼€å‘ Strapi â†’ 1338
```

æ°¸è¿œä¸ä¼šææ··ã€‚

#### åŸåˆ™ 2ï¼šç½‘ç»œéš”ç¦»

```yaml
# deploy/gce/prod/docker-compose.yml
networks:
  cs_prod_net:
    ipam:
      config:
        - subnet: 172.30.0.0/16    # ç”Ÿäº§ç½‘ç»œ

# deploy/gce/dev/docker-compose.yml
networks:
  cs_dev_net:
    ipam:
      config:
        - subnet: 172.31.0.0/16    # å¼€å‘ç½‘ç»œ
```

ç”Ÿäº§å’Œå¼€å‘å®¹å™¨ç‰©ç†éš”ç¦»ï¼Œæ— æ³•äº’ç›¸è®¿é—®ã€‚

#### åŸåˆ™ 3ï¼šå®¹å™¨è®¿é—®å®¿ä¸»æœºæœåŠ¡

**ä¸€ä¸ªé‡è¦çš„"å‘"**ï¼šDocker å®¹å™¨å†…æ— æ³•é€šè¿‡ `localhost` è®¿é—®å®¿ä¸»æœºçš„ PostgreSQL/Redisã€‚

```yaml
# é”™è¯¯ âŒ
DATABASE_URL=postgres://cs:cs@localhost:5432/medusa

# æ­£ç¡® âœ…
DATABASE_URL=postgres://cs:cs@host.docker.internal:5432/medusa
```

`host.docker.internal` æ˜¯ Docker æä¾›çš„ç‰¹æ®Š DNSï¼ŒæŒ‡å‘å®¿ä¸»æœºã€‚

#### åŸåˆ™ 4ï¼šç”¨ Makefile ç»Ÿä¸€å‘½ä»¤

```bash
# æ°¸è¿œä¸è¦ç›´æ¥è¿è¡Œ docker compose
# ç”¨ Makefile å°è£…æ‰€æœ‰æ“ä½œ

make prod-up                      # å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
make prod-down                    # åœæ­¢ç”Ÿäº§ç¯å¢ƒ
make prod-logs SERVICE=medusa     # æŸ¥çœ‹æ—¥å¿—
make dev-up                       # å¯åŠ¨å¼€å‘ç¯å¢ƒ
```

### æ„å»ºæµç¨‹

```bash
# Medusa Docker é•œåƒæ„å»ºï¼ˆå¿…é¡»ä»é¡¹ç›®æ ¹ç›®å½•ï¼Œå› ä¸º monorepo ç»“æ„ï¼‰
docker build -t cs-medusa:prod -f apps/medusa/Dockerfile .

# Dockerfile æ˜¯å¤šé˜¶æ®µæ„å»º
# Stage 1 (Builder): å®‰è£…ä¾èµ– + ç¼–è¯‘ TypeScript + æ„å»º Admin UI
# Stage 2 (Runner): åªå¤åˆ¶ç¼–è¯‘äº§ç‰© + ç”Ÿäº§ä¾èµ–ï¼ˆé•œåƒæ›´å°ï¼‰
```

---

## ç¬¬ä¹ç« ï¼šæ¦‚å¿µé€ŸæŸ¥è¡¨

### æ ¸å¿ƒæ¦‚å¿µä¸€é¡µçº¸

| æ¦‚å¿µ | ä¸€å¥è¯è§£é‡Š | ç±»æ¯” |
|------|----------|------|
| **Module** | ä¸€ç»„å°è£…å¥½çš„ä¸šåŠ¡åŠŸèƒ½ | æ‰‹æœºé‡Œçš„ App |
| **Provider** | æ¨¡å—çš„å…·ä½“å®ç° | App é‡Œé€‰ç”¨çš„ç¬¬ä¸‰æ–¹æœåŠ¡ |
| **API Route** | è‡ªå®šä¹‰ HTTP ç«¯ç‚¹ | å•†åº—çš„æ–°å…¥å£ |
| **Subscriber** | äº‹ä»¶ç›‘å¬å’Œå“åº” | è®¢é˜…æ¨é€é€šçŸ¥ |
| **Workflow** | å¤šæ­¥éª¤äº‹åŠ¡ç¼–æ’ | é“¶è¡Œè½¬è´¦æµç¨‹ |
| **Region** | åœ°åŒº+è´§å¸+ç¨ç‡çš„ç»„åˆ | ä¸åŒå›½å®¶çš„åº—é“ºè®¾ç½® |
| **Sales Channel** | é”€å”®æ¸ é“ï¼ˆWeb/App/B2Bï¼‰ | çº¿ä¸Šå•†åŸ vs å®ä½“åº— |
| **Cart** | ä¸´æ—¶è´­ç‰©çŠ¶æ€ | è´­ç‰©ç¯® |
| **Order** | ç¡®è®¤åçš„è®¢å•è®°å½• | å·²ç­¾æ”¶æ® |
| **Query API** | è·¨æ¨¡å—æ•°æ®æŸ¥è¯¢æ¥å£ | æ•°æ®åº“çš„ JOIN |
| **DI Container** | ä¾èµ–æ³¨å…¥å®¹å™¨ | å…¬å¸å†…éƒ¨ç”µè¯ç°¿ |
| **Link** | è·¨æ¨¡å—æ•°æ®å…³è” | ä¸¤ä¸ªè¡¨ä¹‹é—´çš„å¤–é”® |

### æ–‡ä»¶ç»“æ„é€ŸæŸ¥

```
apps/medusa/
â”œâ”€â”€ medusa-config.ts              â† ä¸€åˆ‡çš„èµ·ç‚¹ï¼Œæ¨¡å—å’ŒProvideræ³¨å†Œ
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                      â† è‡ªå®šä¹‰ API Routeï¼ˆæ–‡ä»¶è·¯å¾„ = URLï¼‰
â”‚   â”‚   â”œâ”€â”€ store/                â† /store/* å‰å°API
â”‚   â”‚   â””â”€â”€ admin/                â† /admin/* ç®¡ç†API
â”‚   â”œâ”€â”€ subscribers/              â† äº‹ä»¶ç›‘å¬å™¨
â”‚   â”œâ”€â”€ modules/                  â† è‡ªå®šä¹‰ Provider
â”‚   â”œâ”€â”€ workflows/                â† è‡ªå®šä¹‰ Workflow
â”‚   â”œâ”€â”€ links/                    â† è·¨æ¨¡å—æ•°æ®å…³è”
â”‚   â”œâ”€â”€ scripts/                  â† å¯æ‰§è¡Œè„šæœ¬ï¼ˆseedç­‰ï¼‰
â”‚   â””â”€â”€ utils/                    â† å·¥å…·å‡½æ•°
â”œâ”€â”€ .env                          â† ç¯å¢ƒå˜é‡
â””â”€â”€ Dockerfile                    â† Docker æ„å»ºæ–‡ä»¶
```

### å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# å¼€å‘
pnpm --filter medusa dev              # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm --filter medusa build            # æ„å»º
pnpm --filter medusa seed             # æ’­ç§æ•°æ®
pnpm --filter medusa start            # ç”Ÿäº§æ¨¡å¼å¯åŠ¨

# æ•°æ®åº“
pnpm medusa user -e admin@example.com -p Password123  # åˆ›å»ºç®¡ç†å‘˜

# æµ‹è¯•
pnpm --filter medusa test:unit                # å•å…ƒæµ‹è¯•
pnpm --filter medusa test:integration:http    # HTTP é›†æˆæµ‹è¯•

# API éªŒè¯
curl http://localhost:9000/health             # å¥åº·æ£€æŸ¥
curl http://localhost:9000/store/products     # è·å–å•†å“
```

### ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§

```
å¿…éœ€ï¼ˆæ— é»˜è®¤å€¼ï¼Œç”Ÿäº§å¿…é¡»è®¾ç½®ï¼‰ï¼š
â”œâ”€â”€ DATABASE_URL
â”œâ”€â”€ REDIS_URL
â”œâ”€â”€ JWT_SECRET       ï¼ˆé»˜è®¤ "supersecret"ï¼Œç”Ÿäº§ä¼šæŠ¥é”™ï¼‰
â””â”€â”€ COOKIE_SECRET    ï¼ˆé»˜è®¤ "supersecret"ï¼Œç”Ÿäº§ä¼šæŠ¥é”™ï¼‰

æŒ‰éœ€é…ç½®ï¼ˆæœ‰äº†æ‰å¯ç”¨å¯¹åº”åŠŸèƒ½ï¼‰ï¼š
â”œâ”€â”€ GOOGLE_CLIENT_ID          â†’ å¯ç”¨ Google ç™»å½•
â”œâ”€â”€ DISCORD_CLIENT_ID + SECRET + CALLBACK â†’ å¯ç”¨ Discord ç™»å½•
â”œâ”€â”€ PAYPAL_CLIENT_ID + SECRET  â†’ å¯ç”¨ PayPal æ”¯ä»˜
â”œâ”€â”€ RESEND_API_KEY             â†’ å¯ç”¨é‚®ä»¶é€šçŸ¥
â””â”€â”€ DISCOURSE_URL + SECRET     â†’ å¯ç”¨è®ºå›åŒæ­¥
```

### é‡‘é¢å•ä½

**å…¨ç³»ç»Ÿç»Ÿä¸€ï¼šé‡‘é¢å•ä½æ˜¯"åˆ†"ï¼ˆcents/minor unitsï¼‰ï¼Œä¸æ˜¯"å…ƒ"ã€‚**

```
100    = $1.00
1500   = $15.00
99999  = $999.99
```

è¿™æ˜¯ç”µå•†ç³»ç»Ÿçš„é€šç”¨åšæ³•ï¼Œé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ï¼ˆ0.1 + 0.2 !== 0.3ï¼‰ã€‚

---

## æ€»ç»“ï¼šä¸‰æ¡æœ€é‡è¦çš„åŸåˆ™

### åŸåˆ™ 1ï¼šæ¨¡å—åŒ–æ˜¯ä¸€åˆ‡çš„åŸºç¡€

Medusa çš„æ¯ä¸ªåŠŸèƒ½éƒ½æ˜¯ç‹¬ç«‹æ¨¡å—ã€‚ä½ å¯ä»¥æ›¿æ¢ä»»ä½•ä¸€ä¸ª Provider è€Œä¸å½±å“å…¶ä»–éƒ¨åˆ†ã€‚æƒ³æ¢æ”¯ä»˜æ–¹å¼ï¼Ÿåªéœ€è¦æ¢ Payment Provider çš„é…ç½®ã€‚æƒ³æ¢é‚®ä»¶æœåŠ¡ï¼Ÿåªéœ€è¦å†™ä¸€ä¸ªæ–°çš„ Notification Providerã€‚

### åŸåˆ™ 2ï¼šäº‹ä»¶é©±åŠ¨å®ç°æ¾è€¦åˆ

æ ¸å¿ƒæ“ä½œï¼ˆä¸‹å•ã€æ³¨å†Œï¼‰é€šè¿‡äº‹ä»¶é€šçŸ¥å…¶ä»–ç³»ç»Ÿã€‚é‚®ä»¶å‘é€ã€è®ºå›åŒæ­¥ã€æ—¥å¿—è®°å½•â€”â€”éƒ½æ˜¯ Subscriber åœ¨ç‹¬ç«‹å¤„ç†ã€‚ä¸€ä¸ª Subscriber æŒ‚äº†ï¼Œä¸å½±å“å…¶ä»–ä»»ä½•ä¸œè¥¿ã€‚

### åŸåˆ™ 3ï¼šå‰åç«¯åˆ†ç¦»å¸¦æ¥çš„è‡ªç”±

Medusa åªè´Ÿè´£ APIï¼Œå‰ç«¯ç”¨ä»€ä¹ˆæ¡†æ¶éƒ½è¡Œã€‚æœ¬é¡¹ç›®ç”¨ Next.js 15 + React Server Componentsï¼Œé€šè¿‡ Medusa JS SDK é€šä¿¡ã€‚ä½ ä¹Ÿå¯ä»¥æ¢æˆ Nuxtã€SvelteKitã€ç”šè‡³ç§»åŠ¨ç«¯ Appâ€”â€”åç«¯ä»£ç ä¸€è¡Œä¸ç”¨æ”¹ã€‚

---

> æœ¬æ•™ç¨‹åŸºäº Cockpit Simulator é¡¹ç›®ï¼ˆMedusa 2.10.3ï¼‰ï¼Œä»£ç è·¯å¾„å‡ä¸ºé¡¹ç›®çœŸå®æ–‡ä»¶ã€‚
